<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PA Watches & Warnings</title>

  <style>
    table { border-collapse: collapse; width: 100%; max-width: 1200px; }
    th, td { padding: 6px; border: 1px solid #333; vertical-align: top; }
    th { background: #f0f0f0; }

    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .nav-toggle { font-size: 0.95em; }

    .nav-toggle button,
    #refreshBtn {
      margin-left: 8px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #fff;
      cursor: pointer;
      font: inherit;
    }
    .nav-toggle button:hover,
    #refreshBtn:hover { background: #f3f3f3; }
    #refreshBtn:disabled { opacity: 0.6; cursor: not-allowed; }

    .refresh-label { font-size: 0.95em; color: #333; }
    .section-title { margin-top: 16px; margin-bottom: 6px; }
    .muted { color: #555; font-size: 0.95em; }

    .type-cell { font-weight: 600; }
    .type-watch   { background: rgba(255,165,0,0.5); }
    .type-warning { background: rgba(220,38,38,0.5); }

    .new-info {
      background: rgba(59,130,246,0.28);
      border-radius: 6px;
      padding: 0 4px;
      display: inline-block;
    }

    /* ===== RWS indicator ===== */
    .rws-hot {
      border-color: rgba(245,158,11,0.95) !important;
      box-shadow: 0 0 14px rgba(245,158,11,0.85);
      animation: rwsPulse 1.25s ease-in-out infinite;
    }
    @keyframes rwsPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.04); }
      100% { transform: scale(1); }
    }
  </style>
</head>

<body>
  <h1>PA Watches & Warnings</h1>
  <div class="muted">INDEX BUILD: RWS-GLOW-CTP v2</div>

  <div class="controls">
    <div class="nav-toggle">
      Want to see advisories as well?
      <button onclick="location.href='advisories.html'">Click here</button>
    </div>
  </div>

  <div class="controls">
    <div class="nav-toggle">
      Need the Regional Weather Summary?
      <button id="rwsBtn" onclick="location.href='rwsctp.html'">Click here</button>
    </div>
  </div>

  <div class="controls">
    <span class="refresh-label">Auto-refresh: every 5 minutes</span>
    <button id="refreshBtn">Refresh Now</button>
  </div>

  <p id="status">Loading alerts…</p>

  <h2 class="section-title">Summary</h2>
  <div id="tableContainer"></div>

<script>
/* ===============================
   CONFIG
   =============================== */
const ALERTS_URL = "https://api.weather.gov/alerts/active?area=PA";
const RWS_LIST_URL = "https://api.weather.gov/products/types/RWS/locations/CTP";
const RWS_STORAGE_KEY = "paAlerts_lastSeen_RWS_CTP_v2";

let currentRwsMarker = null;

/* ===============================
   RWS HELPERS (matches rwsctp.html)
   =============================== */
function pickLatestProduct(items) {
  if (!Array.isArray(items)) return null;
  return items
    .map(p => ({ p, t: Date.parse(p.issuanceTime || p.issueTime || "") }))
    .sort((a,b) => b.t - a.t)[0]?.p || null;
}

function getLatestUrl(latest) {
  return latest?.["@id"] ||
         (latest?.productId ? `https://api.weather.gov/products/${latest.productId}` : null);
}

function buildRwsMarker(latest) {
  return [
    getLatestUrl(latest),
    latest?.issuanceTime || "",
    latest?.wmoCollectiveId || "",
    latest?.awipsId || ""
  ].join("||");
}

/* ===============================
   RWS INDICATOR CHECK
   =============================== */
async function checkRWSIndicator() {
  const btn = document.getElementById("rwsBtn");
  if (!btn) return;

  try {
    const r = await fetch(RWS_LIST_URL, { cache: "no-store" });
    if (!r.ok) return;

    const data = await r.json();
    const latest = pickLatestProduct(data.products || []);
    if (!latest) return;

    currentRwsMarker = buildRwsMarker(latest);
    const lastSeen = localStorage.getItem(RWS_STORAGE_KEY);

    if (!lastSeen) {
      localStorage.setItem(RWS_STORAGE_KEY, currentRwsMarker);
      return;
    }

    if (currentRwsMarker !== lastSeen)
      btn.classList.add("rws-hot");
    else
      btn.classList.remove("rws-hot");

  } catch {}
}

/* Export for console testing */
window.checkRWSIndicator = checkRWSIndicator;
window.getCurrentRwsMarker = () => currentRwsMarker;

/* ===============================
   ACKNOWLEDGE ON CLICK
   =============================== */
document.getElementById("rwsBtn").addEventListener("mousedown", () => {
  if (!currentRwsMarker) return;
  localStorage.setItem(RWS_STORAGE_KEY, currentRwsMarker);
  document.getElementById("rwsBtn").classList.remove("rws-hot");
});

/* ===============================
   ALERT FETCH (simplified)
   =============================== */
async function fetchAlerts() {
  const status = document.getElementById("status");
  status.textContent = "Loading alerts…";

  try {
    const r = await fetch(ALERTS_URL);
    if (!r.ok) throw new Error("Fetch failed");
    const d = await r.json();

    status.textContent =
      `Last updated: ${new Date().toLocaleString()} | Alerts: ${d.features.length}`;

  } catch (e) {
    status.textContent = "Error loading alerts";
  }

  checkRWSIndicator();
}

document.getElementById("refreshBtn").onclick = fetchAlerts;

fetchAlerts();
setInterval(fetchAlerts, 5 * 60 * 1000);
setInterval(checkRWSIndicator, 5 * 60 * 1000);
</script>
</body>
</html>
