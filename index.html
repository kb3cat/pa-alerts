<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PA Watches & Warnings</title>

  <style>
    table { border-collapse: collapse; width: 100%; max-width: 1200px; }
    th, td { padding: 6px; border: 1px solid #333; vertical-align: top; }
    th { background: #f0f0f0; }

    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .nav-toggle { font-size: 0.95em; }

    .nav-toggle button,
    #refreshBtn {
      margin-left: 8px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #fff;
      cursor: pointer;
      font: inherit;
    }
    .nav-toggle button:hover,
    #refreshBtn:hover { background: #f3f3f3; }
    #refreshBtn:disabled { opacity: 0.6; cursor: not-allowed; }

    .refresh-label { font-size: 0.95em; color: #333; }

    .section-title { margin-top: 16px; margin-bottom: 6px; }
    .muted { color: #555; font-size: 0.95em; }

    .type-cell { font-weight: 600; color: #111; }
    .type-watch   { background-color: rgba(255, 165, 0, 0.5); }
    .type-warning { background-color: rgba(220, 38, 38, 0.5); }

    .new-info {
      background: rgba(59, 130, 246, 0.28);
      border: 1px solid rgba(59, 130, 246, 0.35);
      border-radius: 6px;
      padding: 0 4px;
      display: inline-block;
    }

    button.view-btn {
      padding: 4px 10px;
      border: 1px solid #555;
      background: #fff;
      cursor: pointer;
      border-radius: 4px;
      font: inherit;
    }
    button.view-btn:hover { background: #f3f3f3; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 9999;
    }
    .modal {
      background: #fff;
      color: #111;
      width: min(900px, 100%);
      max-height: 85vh;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #333;
      padding: 14px 16px 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    .modal h3 { margin: 0 0 8px; }
    .modal .meta { margin: 0 0 10px; color: #333; font-size: 0.95em; }
    .modal .label { margin-top: 10px; font-weight: 700; }
    .modal pre {
      white-space: pre-wrap;
      word-break: break-word;
      margin: 6px 0 0;
      padding: 10px;
      background: #f6f6f6;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 0.95em;
      line-height: 1.35;
    }
    .modal .actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .modal .actions button {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #fff;
      cursor: pointer;
      font: inherit;
    }
    .modal .actions button:hover { background: #f3f3f3; }

    .embed-wrap {
      max-width: 1200px;
      width: 100%;
      border: 1px solid #ccc;
      overflow: hidden;
    }
    .embed-wrap iframe {
      width: 100%;
      height: 520px;
      border: 0;
      display: block;
    }
  </style>
</head>

<body>
  <h1>PA Watches & Warnings</h1>

  <div class="controls">
    <div class="nav-toggle">
      Want to see advisories as well?
      <button type="button" onclick="window.location.href='advisories.html'">Click here</button>
    </div>
  </div>

  <div class="controls">
    <div class="nav-toggle">
      Need the Regional Weather Summary?
      <button type="button" onclick="window.location.href='rwsctp.html'">Click here</button>
    </div>
  </div>

  <div class="controls">
    <span class="refresh-label">Auto-refresh: every 5 minutes</span>
    <button id="refreshBtn" type="button">Refresh Now</button>
  </div>

  <p id="status">Loading alertsâ€¦</p>

  <h2 class="section-title">Summary</h2>
  <div class="muted">New information since the last update will be highlighted in blue.</div>
  <div id="tableContainer"></div>

  <h2 class="section-title">Alert Links</h2>
  <div class="muted">New information since the last update will be highlighted in blue.</div>
  <div id="linksContainer"></div>

  <h2 style="margin-top: 18px;">Alert Map</h2>
  <img
    id="wwaMap"
    src="https://www.weather.gov/images/crh/noc/wwa_pa.png"
    alt="NWS Current Watches, Warnings, and Advisories (PA)"
    style="max-width: 1200px; width: 100%; height: auto; border: 1px solid #ccc;"
  />

  <h2 style="margin-top: 18px;">Live Radar</h2>
  <div class="embed-wrap">
    <iframe
      title="Windy Radar"
      src="https://embed.windy.com/embed2.html?lat=40.9&lon=-77.9&zoom=6&overlay=radar"
      loading="lazy"
      allowfullscreen>
    </iframe>
  </div>

  <script>
    const API_URL = "https://api.weather.gov/alerts/active?area=PA";
    const MAP_URL = "https://www.weather.gov/images/crh/noc/wwa_pa.png";
    const STORAGE_KEY = "paAlertsSnapshot_index_v1";

    const zoneCache = new Map();
    const alertStore = new Map();

    function normalizeSummaryCounty(name) {
      let s = String(name || "").trim();

      // remove directional prefixes INCLUDING Upper/Lower
      s = s.replace(
        /^(North|South|East|West|Northeast|Northwest|Southeast|Southwest|Northern|Southern|Eastern|Western|Upper|Lower)\s+/i,
        ""
      );

      // remove elevation prefixes
      s = s.replace(/^(Higher\s+Elevations\s+of|Elevations\s+of)\s+/i, "");

      // remove ridge/elevation suffixes
      s = s.replace(/\s+(Ridges?|Ridge|Higher\s+Elevations?)$/i, "");

      return s.trim();
    }

    function isWatchWarningEmergencyOnly(p) {
      const e = (p.event || "").toLowerCase();
      return (e.includes("watch") || e.includes("warning") || e.includes("emergency"))
        && !e.includes("advisory")
        && !e.includes("statement")
        && !e.includes("outlook")
        && !e.includes("test");
    }

    function fetchZone(url) {
      if (zoneCache.has(url)) return zoneCache.get(url);
      return fetch(url)
        .then(r => r.json())
        .then(d => {
          const info = { name: d.properties?.name, state: d.properties?.state };
          zoneCache.set(url, info);
          return info;
        })
        .catch(() => null);
    }

    function sortLocations(arr) {
      return [...arr].sort((a, b) => a.localeCompare(b));
    }

    async function fetchAlerts() {
      const r = await fetch(API_URL, { headers: { Accept: "application/geo+json" } });
      const d = await r.json();
      const rows = [];

      for (const f of d.features || []) {
        const p = f.properties;
        if (!p || !isWatchWarningEmergencyOnly(p)) continue;

        const names = [];
        for (const z of p.affectedZones || []) {
          const info = await fetchZone(z);
          if (info?.state === "PA" && info.name) names.push(info.name);
        }

        if (names.length) {
          rows.push({ event: p.event, expires: p.ends || p.expires, names });
        }
      }

      const grouped = new Map();
      for (const r of rows) {
        const key = r.event + "|" + (r.expires || "");
        if (!grouped.has(key)) grouped.set(key, { event: r.event, expires: r.expires, names: new Set() });
        r.names.forEach(n => grouped.get(key).names.add(normalizeSummaryCounty(n)));
      }

      document.getElementById("tableContainer").innerHTML = `
        <table>
          <tr><th>Type</th><th>Locations</th><th>Expires</th></tr>
          ${[...grouped.values()].map(g => `
            <tr>
              <td>${g.event}</td>
              <td>${sortLocations([...g.names]).join("; ")}</td>
              <td>${g.expires || "N/A"}</td>
            </tr>
          `).join("")}
        </table>
      `;
    }

    fetchAlerts();
    setInterval(fetchAlerts, 5 * 60 * 1000);
  </script>
</body>
</html>
