<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PA Watches & Warnings</title>

  <style>
    table { border-collapse: collapse; width: 100%; max-width: 1200px; }
    th, td { padding: 6px; border: 1px solid #333; vertical-align: top; }
    th { background: #f0f0f0; }

    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .nav-toggle {
      font-size: 0.95em;
    }

    .nav-toggle button {
      margin-left: 8px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #fff;
      cursor: pointer;
      font: inherit;
    }

    .nav-toggle button:hover {
      background: #f3f3f3;
    }

    .refresh-label {
      font-size: 0.95em;
      color: #333;
    }

    .section-title {
      margin-top: 16px;
      margin-bottom: 6px;
    }

    .muted {
      color: #555;
      font-size: 0.95em;
    }

    .type-cell { font-weight: 600; color: #111; }
    .type-watch   { background-color: rgba(255, 165, 0, 0.5); }
    .type-warning { background-color: rgba(220, 38, 38, 0.5); }

    button.view-btn {
      padding: 4px 10px;
      border: 1px solid #555;
      background: #fff;
      cursor: pointer;
      border-radius: 4px;
      font: inherit;
    }
    button.view-btn:hover { background: #f3f3f3; }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 9999;
    }
    .modal {
      background: #fff;
      width: min(900px, 100%);
      max-height: 85vh;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #333;
      padding: 14px 16px 16px;
    }
    .modal h3 { margin: 0 0 8px; }
    .modal .meta { margin: 0 0 10px; font-size: 0.95em; }
    .modal pre {
      white-space: pre-wrap;
      background: #f6f6f6;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 6px;
      font-family: ui-monospace, monospace;
    }
  </style>
</head>

<body>
  <h1>PA Watches & Warnings</h1>

  <!-- TOP NAV -->
  <div class="controls">
    <div class="nav-toggle">
      Want to see advisories as well?
      <button type="button" onclick="location.href='advisories.html'">Click here</button>
    </div>
  </div>

  <div class="controls">
    <span class="refresh-label">Auto-refresh: every 5 minutes</span>
    <!-- NO custom styling here — matches advisories -->
    <button id="refreshBtn">Refresh Now</button>
  </div>

  <p id="status">Loading alerts…</p>

  <h2 class="section-title">Summary</h2>
  <div id="tableContainer"></div>

  <h2 class="section-title">Alert Links</h2>
  <div id="linksContainer"></div>

  <h2 class="section-title">Alert Map</h2>
  <img
    id="wwaMap"
    src="https://www.weather.gov/images/crh/noc/wwa_pa.png"
    style="max-width:1200px;width:100%;border:1px solid #ccc"
    alt="NWS PA Watches and Warnings"
  />
  <p class="muted">
    Map source:
    <a href="https://www.weather.gov/images/crh/noc/wwa_pa.png" target="_blank">
      NWS Current Watches, Warnings, and Advisories (PA)
    </a>
  </p>

  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3 id="modalTitle"></h3>
      <p id="modalMeta" class="meta"></p>
      <pre id="modalDescription"></pre>
      <button onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    const API_URL = "https://api.weather.gov/alerts/active?area=PA";
    const MAP_URL = "https://www.weather.gov/images/crh/noc/wwa_pa.png";
    const alertStore = [];

    function formatTime(v) {
      return v ? new Date(v).toLocaleString() : "N/A";
    }

    function typeClass(e) {
      e = e.toLowerCase();
      if (e.includes("warning")) return "type-warning";
      return "type-watch";
    }

    function refreshMap() {
      document.getElementById("wwaMap").src = MAP_URL + "?t=" + Date.now();
    }

    async function fetchAlerts() {
      document.getElementById("status").textContent = "Loading alerts…";

      const r = await fetch(API_URL);
      const d = await r.json();

      const rows = [];
      for (const f of d.features || []) {
        const p = f.properties;
        if (!p.event.toLowerCase().includes("watch") &&
            !p.event.toLowerCase().includes("warning")) continue;

        rows.push({
          event: p.event,
          expires: p.expires,
          locations: p.areaDesc,
          description: p.description
        });
      }

      document.getElementById("status").textContent =
        `Last updated: ${new Date().toLocaleString()} | Alerts: ${rows.length}`;

      document.getElementById("tableContainer").innerHTML = `
        <table>
          <tr><th>Type</th><th>Locations</th><th>Expires</th></tr>
          ${rows.map(r => `
            <tr>
              <td class="type-cell ${typeClass(r.event)}">${r.event}</td>
              <td>${r.locations}</td>
              <td>${formatTime(r.expires)}</td>
            </tr>`).join("")}
        </table>
      `;

      document.getElementById("linksContainer").innerHTML = `
        <table>
          <tr><th>Type</th><th>Locations</th><th>Text</th></tr>
          ${rows.map((r,i)=>`
            <tr>
              <td class="type-cell ${typeClass(r.event)}">${r.event}</td>
              <td>${r.locations}</td>
              <td><button class="view-btn" onclick="openModal(${i})">View Text</button></td>
            </tr>`).join("")}
        </table>
        <p class="muted">“View Text” opens the full warning text.</p>
      `;

      alertStore.length = 0;
      rows.forEach(r => alertStore.push(r));
      refreshMap();
    }

    function openModal(i) {
      const a = alertStore[i];
      document.getElementById("modalTitle").textContent = a.event;
      document.getElementById("modalMeta").textContent =
        `Expires: ${formatTime(a.expires)}`;
      document.getElementById("modalDescription").textContent = a.description;
      document.getElementById("modalBackdrop").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("modalBackdrop").style.display = "none";
    }

    document.getElementById("refreshBtn").onclick = fetchAlerts;
    fetchAlerts();
    setInterval(fetchAlerts, 5 * 60 * 1000);
  </script>
</body>
</html>