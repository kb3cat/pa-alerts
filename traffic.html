<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pennsylvania 511 Roadway Status Board</title>

  <style>
    :root{
      --bg:#0b0f19;
      --card:#121a2a;
      --text:#e7eefc;
      --muted:rgba(231,238,252,.72);
      --border:rgba(255,255,255,.10);
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(90,120,255,.25), transparent 60%),
                  radial-gradient(1000px 700px at 100% 0%, rgba(0,255,180,.15), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:18px 14px 40px;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding:14px 14px;
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(18,26,42,.75);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .titleBlock h1{
      margin:0;
      font-size:1.35rem;
      letter-spacing:.2px;
    }
    .titleBlock .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:.92rem;
    }

    .statusBlock{
      text-align:right;
      min-width:240px;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:.38rem .78rem;
      border-radius:999px;
      font-weight:800;
      font-size:.92rem;
      border:1px solid rgba(255,255,255,.14);
      user-select:none;
      white-space:nowrap;
    }
    .status-dot{
      width:10px;
      height:10px;
      border-radius:999px;
      background: currentColor;
      opacity:.9;
    }

    .status-ok{
      background: rgba(0, 180, 0, .18);
      color: #c9ffcf;
      border-color: rgba(0, 180, 0, .35);
    }

    .status-attn{
      background: rgba(255, 165, 0, .18);
      color: #ffe6b8;
      border-color: rgba(255, 165, 0, .35);
    }

    .status-err{
      background: rgba(255, 0, 0, .18);
      color: #ffd0d0;
      border-color: rgba(255, 0, 0, .35);
    }

    .last-updated{
      margin-top:.4rem;
      font-size:.82rem;
      color:var(--muted);
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    .card{
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(18,26,42,.75);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      padding:14px;
    }

    .card h2{
      margin:0 0 10px 0;
      font-size:1.05rem;
      letter-spacing:.2px;
    }

    .meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:.9rem;
    }
    .meta .pill{
      padding:.25rem .55rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
    }

    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.10);
    }
    thead th{
      text-align:left;
      font-size:.85rem;
      color:var(--muted);
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.03);
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
      font-size:.92rem;
    }
    tbody tr:last-child td{border-bottom:none}
    .muted{color:var(--muted)}
    .right{text-align:right}

    .footerNote{
      margin-top:12px;
      color:var(--muted);
      font-size:.85rem;
      line-height:1.35;
    }

    .errorBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,0,0,.35);
      background: rgba(255,0,0,.12);
      color:#ffd0d0;
      display:none;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="titleBlock">
        <h1 id="boardTitle">Pennsylvania 511 Roadway Status Board</h1>
        <div class="sub">Automated pull every 5 minutes (GitHub Action). Board refreshes in-browser.</div>
      </div>

      <div class="statusBlock">
        <div id="boardStatus" class="status-pill status-ok">
          <span class="status-dot"></span>
          <span id="boardStatusText">OK</span>
        </div>
        <div id="lastUpdated" class="last-updated">Last updated: —</div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>Summary</h2>
        <div class="meta">
          <span class="pill">Attention items: <strong id="attentionCount">0</strong></span>
          <span class="pill">Data age (min): <strong id="ageMinutes">—</strong></span>
          <span class="pill">Source file: <strong id="sourceFileLabel">—</strong></span>
        </div>
        <div id="errorBox" class="errorBox"></div>
        <div class="footerNote">
          Status logic:
          <strong>Green</strong> = updating + nothing flagged.
          <strong>Orange</strong> = updating + at least one attention item.
          <strong>Red</strong> = stale or failed fetch.
        </div>
      </section>

      <section class="card">
        <h2>Items</h2>
        <table>
          <thead>
            <tr>
              <th style="width:160px;">Type</th>
              <th>Description</th>
              <th style="width:220px;">Location</th>
              <th style="width:160px;">Last Update</th>
            </tr>
          </thead>
          <tbody id="itemsTbody">
            <tr>
              <td class="muted" colspan="4">Loading…</td>
            </tr>
          </tbody>
        </table>
        <div class="footerNote">
          This table expects your JSON to have an array like <code>incidents</code>, <code>events</code>, or <code>closures</code>.
          If yours differs, scroll down to the “CONFIG” section in the script and adjust <code>DATA_URL</code> and <code>pickItems()</code>.
        </div>
      </section>
    </div>
  </div>

  <script>
    /*****************************************************************
     * CONFIG — YOU MUST SET THIS TO A JSON YOUR SCRAPER PRODUCES
     *****************************************************************/
    // Pick ONE JSON file that always exists in your repo.
    // Examples: "./data/pa511.json", "./data/incidents.json", "./data/cameras.json"
    const DATA_URL = "./data/pa511.json";

    // If the data is older than this, show RED (NOT UPDATING)
    const STALE_MINUTES = 15;

    // If attention items >= this AND data is fresh, show ORANGE
    const ATTENTION_MIN = 1;

    // How often the page re-checks status (does NOT affect GitHub Action)
    const UI_REFRESH_MS = 60_000;

    /*****************************************************************
     * UI helpers
     *****************************************************************/
    const els = {
      statusPill: document.getElementById("boardStatus"),
      statusText: document.getElementById("boardStatusText"),
      lastUpdated: document.getElementById("lastUpdated"),
      attentionCount: document.getElementById("attentionCount"),
      ageMinutes: document.getElementById("ageMinutes"),
      tbody: document.getElementById("itemsTbody"),
      errorBox: document.getElementById("errorBox"),
      sourceFileLabel: document.getElementById("sourceFileLabel")
    };

    function setStatus(state, text){
      els.statusPill.classList.remove("status-ok","status-attn","status-err");
      if (state === "ok") els.statusPill.classList.add("status-ok");
      if (state === "attn") els.statusPill.classList.add("status-attn");
      if (state === "err") els.statusPill.classList.add("status-err");
      els.statusText.textContent = text;
    }

    function setLastUpdated(dt){
      els.lastUpdated.textContent = dt
        ? `Last updated: ${dt.toLocaleString()}`
        : "Last updated: —";
    }

    function showError(msg){
      els.errorBox.style.display = msg ? "block" : "none";
      els.errorBox.textContent = msg || "";
    }

    function minutesAgo(dt){
      return (Date.now() - dt.getTime()) / 60000;
    }

    /*****************************************************************
     * Data interpretation
     * Adjust pickItems() if your JSON structure is different.
     *****************************************************************/
    function pickItems(json){
      // Try common keys in priority order:
      if (Array.isArray(json?.incidents)) return json.incidents.map(x => ({...x, __type:"Incident"}));
      if (Array.isArray(json?.events)) return json.events.map(x => ({...x, __type:"Event"}));
      if (Array.isArray(json?.closures)) return json.closures.map(x => ({...x, __type:"Closure"}));

      // If the JSON itself is an array:
      if (Array.isArray(json)) return json.map(x => ({...x, __type: x?.type || "Item"}));

      // Nothing recognized:
      return [];
    }

    function formatItemRow(item){
      // Best-effort field mapping (safe defaults)
      const type = item.__type || item.type || "Item";
      const desc = item.description || item.desc || item.title || item.summary || JSON.stringify(item);
      const loc = item.location || item.road || item.segment || item.county || item.region || "";
      const updated = item.updated || item.last_updated || item.lastUpdate || item.timestamp || "";

      const updatedText = updated ? String(updated) : "—";

      return `
        <tr>
          <td>${escapeHtml(type)}</td>
          <td>${escapeHtml(desc)}</td>
          <td>${escapeHtml(loc || "—")}</td>
          <td>${escapeHtml(updatedText)}</td>
        </tr>
      `;
    }

    function renderItems(items){
      if (!items.length){
        els.tbody.innerHTML = `<tr><td class="muted" colspan="4">No items found in JSON (or structure not recognized).</td></tr>`;
        return;
      }
      // Show up to 200 to keep UI snappy
      const top = items.slice(0, 200);
      els.tbody.innerHTML = top.map(formatItemRow).join("");
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /*****************************************************************
     * Fetch + status logic
     *****************************************************************/
    async function fetchJsonAndLastModified(url){
      // Cache-bust so we see the freshest file from Pages/CDN
      const bust = (url.includes("?") ? "&" : "?") + "v=" + Date.now();
      const res = await fetch(url + bust, { cache: "no-store" });
      if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);

      // GitHub Pages usually provides Last-Modified for static assets.
      const lastModHeader = res.headers.get("last-modified");
      const dt = lastModHeader ? new Date(lastModHeader) : new Date();

      const json = await res.json();
      return { dt, json };
    }

    async function updateBoard(){
      els.sourceFileLabel.textContent = DATA_URL;

      try{
        showError("");

        const { dt, json } = await fetchJsonAndLastModified(DATA_URL);

        const ageMin = minutesAgo(dt);
        const items = pickItems(json);
        const attention = items.length;

        // Update UI numbers
        setLastUpdated(dt);
        els.attentionCount.textContent = String(attention);
        els.ageMinutes.textContent = ageMin.toFixed(1);

        // Status logic
        if (ageMin > STALE_MINUTES){
          setStatus("err","NOT UPDATING");
        } else if (attention >= ATTENTION_MIN){
          setStatus("attn","NEEDS ATTENTION");
        } else {
          setStatus("ok","OK");
        }

        renderItems(items);
      } catch (err){
        // Red if we can't load the data at all
        setStatus("err","NOT UPDATING");
        setLastUpdated(null);
        els.attentionCount.textContent = "—";
        els.ageMinutes.textContent = "—";
        els.tbody.innerHTML = `<tr><td class="muted" colspan="4">Failed to load data.</td></tr>`;
        showError(String(err));
        console.error(err);
      }
    }

    // Initial load + periodic refresh
    updateBoard();
    setInterval(updateBoard, UI_REFRESH_MS);
  </script>
</body>
</html>
