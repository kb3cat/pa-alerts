<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pennsylvania 511 Roadway Status Board</title>

<style>
:root{
  --bg:#0f0f10;
  --panel2:#1d1d1f;
  --border:#2a2a2d;
  --text:#e9e9ea;
  --muted:#a7a7aa;
  --orange:#ffb000;
  --red:#ff2b2b;
  --blue:#00bfff;
  --yellow:#ffe600;
  --green:#29d36a;
}

body{ margin:0; background:var(--bg); color:var(--text); font-family: Arial, Helvetica, sans-serif; }

/* HEADER */
.topbar{
  background:#222;
  border-bottom:2px solid var(--border);
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap: 14px;
}
.title{ font-size:22px; font-weight:700; }
.subtitle{ color:var(--muted); font-size:13px; margin-top: 2px; }
.header-left{ display:flex; flex-direction:column; }

/* Status pill (upper right) */
.status-pill{
  display:inline-flex;
  align-items:center;
  gap:.5rem;
  padding:6px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  border:1px solid rgba(255,255,255,.14);
  user-select:none;
  white-space:nowrap;
}
.status-dot{
  width:10px;
  height:10px;
  border-radius:999px;
  background: currentColor;
  opacity:.95;
  box-shadow: 0 0 0 3px rgba(255,255,255,.06);
}
.status-ok{
  background: rgba(41, 211, 106, .18);
  color: #c9ffcf;
  border-color: rgba(41, 211, 106, .35);
}
.status-attn{
  background: rgba(255, 176, 0, .18);
  color: #ffe6b8;
  border-color: rgba(255, 176, 0, .35);
}
.status-err{
  background: rgba(255, 43, 43, .18);
  color: #ffd0d0;
  border-color: rgba(255, 43, 43, .35);
}

/* ROWS */
.grid{ padding:10px; }
.row{
  background:var(--panel2);
  border:1px solid var(--border);
  border-radius:6px;
  margin-bottom:12px;
  padding:10px 12px;
}

/* TITLES */
.paneltitle{
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid var(--border);
  padding-bottom:8px;
  margin-bottom:8px;
}
.paneltitle .name{ font-size:22px; font-weight:900; color:var(--orange); }
.paneltitle .count{ font-size:18px; color:var(--muted); }

/* Vehicle summary next to panel title */
.veh-summary{
  font-size:12px;
  font-weight:400;
  color:var(--muted);
  white-space:nowrap;
}
.veh-summary .t1{ color:#a855f7; }
.veh-summary .t2{ color:#f59e0b; }
.veh-summary .t3{ color:#3b82f6; }
.veh-summary .t4{ color:#ef4444; }
.veh-summary .t5{ color:#ec4899; }
.veh-summary .rl45{ color:#3b82f6; }

/* ITEMS */
.items{ max-height:45vh; overflow:auto; }
.item{
  padding:10px;
  margin:8px 0;
  background:#141415;
  border:1px solid #232326;
  border-left:7px solid var(--red);
  border-radius:6px;
  font-size:15px;
  line-height:1.25;
  word-break:break-word;
}
.speed .item{ border-left-color: var(--blue); }
.vehicle .item{ border-left-color: var(--yellow); }

/* Vehicle grouping headers */
.grouphead{
  padding:8px 10px;
  margin:10px 0 6px;
  border-radius:6px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  color: var(--text);
  font-weight: 400;         /* not bold */
  font-size: 15px;          /* slightly larger than before */
  letter-spacing: .02em;
}
.grouphead small{
  color: var(--muted);
  font-weight: 400;         /* not bold */
  margin-left: 6px;
}

/* Tier header font colors (to match 511 legend style) */
.grouphead.tier1{ color:#a855f7; }  /* purple */
.grouphead.tier2{ color:#f59e0b; }  /* orange */
.grouphead.tier3{ color:#3b82f6; }  /* blue */
.grouphead.tier4{ color:#ef4444; }  /* red */
.grouphead.tier5{ color:#ec4899; }  /* pink */
.grouphead.rl45{ color:#3b82f6; }   /* blue (speed/CMV style) */

/* FOOTER */
.footer{
  position:fixed;
  bottom:8px;
  right:12px;
  color:var(--muted);
  font-size:12px;
  background:rgba(0,0,0,.25);
  padding:6px 10px;
  border:1px solid rgba(255,255,255,.08);
  border-radius:999px;
}
</style>
</head>

<body>

<div class="topbar">
  <div class="header-left">
    <div class="title">Pennsylvania 511 Roadway Status Board</div>
    <div class="subtitle">Requested every 5 minutes via GitHub Actions; execution timing may vary.</div>
  </div>

  <!-- Upper-right status pill (pipeline health) -->
  <div id="statuspill" class="status-pill status-err" title="Loading…">
    <span class="status-dot"></span>
    <span id="statusline">LOADING…</span>
  </div>
</div>

<div class="grid">

  <div class="row closures">
    <div class="paneltitle">
      <div class="name">Closures</div>
      <div class="count" id="closuresCount">—</div>
    </div>
    <div class="items" id="closuresList"></div>
  </div>

  <div class="row speed">
    <div class="paneltitle">
      <div class="name">Speed Restrictions</div>
      <div class="count" id="speedCount">—</div>
    </div>
    <div class="items" id="speedList"></div>
  </div>

  <div class="row vehicle">
    <div class="paneltitle">
      <div class="name">Vehicle Restrictions</div>
      <div class="count">
        <span class="veh-summary" id="vehSummary">T1=0 / T2=0 / T3=0 / T4=0 / T5=0 / 45=0</span>
      </div>
    </div>
    <div class="items" id="vehicleList"></div>
  </div>

</div>

<div class="footer" id="updated">Data Last Updated: —</div>

<script>
const REFRESH_MS = 60000;

// ✅ Closures now come from the derived file generated by the scraper
const CLOSURES_FILE = "major_route_closures.json";

// Speed/vehicle still come from restrictions.json
const RESTR_FILE = "restrictions.json";

// Written by the Action each run (workflow below)
const LAST_RUN_FILE = "last_run.json";

// ✅ Changed to 25 minutes to avoid false reds from GitHub schedule jitter
const STALE_MINUTES = 25;

function candidatePaths(filename) {
  const here = new URL(".", window.location.href);
  const parts = location.pathname.split("/").filter(Boolean);
  const repoBase = parts.length ? `/${parts[0]}/` : "/";

  return [
    new URL(`data/${filename}`, here).toString(),
    new URL(`../data/${filename}`, here).toString(),
    new URL(`${repoBase}data/${filename}`, window.location.origin).toString()
  ];
}

async function fetchFirstWorkingJson(filename) {
  let lastErr = null;

  for (const p of candidatePaths(filename)) {
    try {
      const r = await fetch(p + (p.includes("?") ? "&" : "?") + "v=" + Date.now(), { cache:"no-store" });
      if (!r.ok) { lastErr = new Error(`${r.status} ${r.statusText}`); continue; }
      const json = await r.json();
      return { json, sourceUrl: p };
    } catch (e) {
      lastErr = e;
    }
  }

  throw new Error(`JSON not found: ${filename}` + (lastErr ? ` (last error: ${lastErr})` : ""));
}

function minutesAgo(dt) {
  return (Date.now() - dt.getTime()) / 60000;
}

function setStatus(state, text, hover) {
  const pill = document.getElementById("statuspill");
  const line = document.getElementById("statusline");

  if (!pill || !line) return;

  pill.classList.remove("status-ok","status-attn","status-err");
  if (state === "ok") pill.classList.add("status-ok");
  if (state === "attn") pill.classList.add("status-attn");
  if (state === "err") pill.classList.add("status-err");

  line.textContent = text;
  pill.title = hover || "";
}

/* --- Hard stop on "stuck loading": surface any JS errors in the pill --- */
window.addEventListener("error", (e) => {
  try {
    setStatus("err","JS ERROR", (e && e.message) ? e.message : "Unknown error");
  } catch {}
});
window.addEventListener("unhandledrejection", (e) => {
  try {
    const r = e && e.reason;
    const msg = r ? (r.stack || r.message || String(r)) : "Unhandled rejection";
    setStatus("err","JS ERROR", msg);
  } catch {}
});

function normalizeRows(rows) {
  return (rows || [])
    .map(r => Array.isArray(r) ? r.join(" | ") : String(r || ""))
    .map(s => s.trim())
    .filter(Boolean);
}

// Remove junk/boilerplate phrases and trailing “status chips”
function cleanLine(s) {
  let t = s;

  t = t.replace(/^Row Details\s*\|\s*/i, "");
  t = t.replace(/\bOther incident on\b\s*/i, "");

  t = t.replace(/\s*\|\s*I-\d+\s*\|\s*ACTIVE\s*\|\s*View on map\s*$/i, "");
  t = t.replace(/\s*\|\s*US-\d+\s*\|\s*ACTIVE\s*\|\s*View on map\s*$/i, "");
  t = t.replace(/\s*\|\s*PA-\d+\s*\|\s*ACTIVE\s*\|\s*View on map\s*$/i, "");
  t = t.replace(/\s*\|\s*ACTIVE\s*\|\s*View on map\s*$/i, "");
  t = t.replace(/\s*\|\s*View on map\s*$/i, "");

  t = t.replace(/\s*\|\s*\|\s*/g, " | ");
  t = t.replace(/\s{2,}/g, " ");

  return t.trim();
}

function isFakeHeaderRow(s) {
  const t = s.trim().toLowerCase();

  if (t === "speed restrictions") return true;
  if (t === "vehicle restrictions") return true;
  if (t === "restrictions") return true;

  const hasRoadHint = /(i-\d+|us-\d+|pa-\d+|turnpike|route|sr\s*\d+|exit)/i.test(s);

  // Allow tier header rows through so we can apply context
  if (/^tier\s*[1-5]\b/i.test(s)) return false;

  if (!hasRoadHint && t.length <= 25) return true;

  const hasDigit = /\d/.test(s);
  if (!hasDigit && !hasRoadHint) return true;

  return false;
}

function renderList(elId, items, kind) {
  const el = document.getElementById(elId);
  if (!el) return;

  el.innerHTML = "";

  if (!items.length) {
    const div = document.createElement("div");
    div.className = `item ${kind || ""}`;
    div.style.borderLeftColor = "var(--green)";
    div.textContent = "None currently reported";
    el.appendChild(div);
    return;
  }

  items.forEach(text => {
    const div = document.createElement("div");
    div.className = `item ${kind || ""}`;
    div.textContent = text;
    el.appendChild(div);
  });
}

/* Speed restrictions */
function isSpeedRestriction(text) {
  const hasRoad = /(i-\d+|us-\d+|pa-\d+|turnpike|route|sr\s*\d+|exit)/i.test(text);
  const hasSpeed = /\b(mph|speed)\b/i.test(text);
  return hasSpeed && hasRoad;
}

/* 45 MPH - CMV Right Lane Only (under Vehicle Restrictions after tiers) */
function is45CmvRightLaneOnly(text){
  const hasRoad = /(i-\d+|us-\d+|pa-\d+|turnpike|route|sr\s*\d+|exit)/i.test(text);
  if (!hasRoad) return false;

  const mph45 = /\b45\s*mph\b/i.test(text);
  const rightLaneOnly = /\bright\s*lane\s*only\b/i.test(text) || /\brt\.?\s*lane\s*only\b/i.test(text);

  const cmvRightLane =
    /\bcommercial\s*vehicles?\s*right\s*lane\s*only\b/i.test(text) ||
    /\bcmv\s*right\s*lane\s*only\b/i.test(text) ||
    (/\bcommercial\s*vehicles?\b/i.test(text) && rightLaneOnly) ||
    (/\bcmv\b/i.test(text) && rightLaneOnly);

  return mph45 && rightLaneOnly && cmvRightLane;
}

function formatDataLastUpdated(dt) {
  if (!dt) return "Data Last Updated: —";
  return "Data Last Updated: " + dt.toLocaleString();
}

/* Tier context parsing (tier header applies to rows that follow) */
function extractTierHeader(s){
  const t = (s || "").trim();
  const m = t.match(/^tier\s*([1-5])\s*[:\-]/i);
  if (m) return Number(m[1]);

  const m2 = t.match(/^tier\s*([1-5])\b/i);
  if (m2 && t.length <= 60) return Number(m2[1]);

  return null;
}

function applyTierContext(rows){
  let currentTier = null;
  const out = [];

  for (const text of (rows || [])) {
    const hdr = extractTierHeader(text);
    if (hdr) { currentTier = hdr; continue; } // do not include the header itself
    out.push({ text, tier: currentTier });
  }

  return out;
}

/* Vehicle grouping helpers */
function getTierFromText(text){
  const t = (text || "").toLowerCase();

  const m = t.match(/\btier\s*([1-5])\b/);
  if (m) return Number(m[1]);

  if (t.includes("complete cmv restriction")) return 4;
  if (t.includes("all passenger vehicles")) return 5;

  return null;
}

function vehiclePanelCandidate(text){
  const hasRoad = /(i-\d+|us-\d+|pa-\d+|turnpike|route|sr\s*\d+|exit)/i.test(text);
  if (!hasRoad) return false;

  return (
    /\btier\s*[1-5]\b/i.test(text) ||
    /\bcomplete cmv restriction\b/i.test(text) ||
    /\ball passenger vehicles\b/i.test(text) ||
    /\bcmv\b/i.test(text) ||
    /\bcommercial\b/i.test(text) ||
    /\btruck(s)?\b/i.test(text) ||
    /\bpermit\b/i.test(text) ||
    /\bno permit travel\b/i.test(text) ||
    /\btrailer\b/i.test(text) ||
    /\btowing\b/i.test(text) ||
    /\bmotor coach|motorcoach|school bus|commercial bus|motorcycle\b/i.test(text) ||
    /\bchains?\b/i.test(text) ||
    /\batd\b/i.test(text)
  );
}

/* Numeric sort helper */
function routeKey(text){
  const s = String(text || "");
  const m = s.match(/\b(I|US|PA)\s*[- ]?\s*(\d{1,4})\b/i);
  if (!m) return { grp: 9, num: 99999 };

  const type = m[1].toUpperCase();
  const num = parseInt(m[2], 10);

  const grp = (type === "I") ? 1 : (type === "US") ? 2 : 3;
  return { grp, num: isNaN(num) ? 99999 : num };
}
function sortByRoute(a,b){
  const ka = routeKey(a), kb = routeKey(b);
  if (ka.grp !== kb.grp) return ka.grp - kb.grp;
  if (ka.num !== kb.num) return ka.num - kb.num;
  return String(a).localeCompare(String(b));
}

function renderVehicleGrouped(elId, items){
  const el = document.getElementById(elId);
  if (!el) return;

  el.innerHTML = "";

  if (!items.length) {
    const div = document.createElement("div");
    div.className = "item vehicle";
    div.style.borderLeftColor = "var(--green)";
    div.textContent = "None currently reported";
    el.appendChild(div);

    const summaryEl = document.getElementById("vehSummary");
    if (summaryEl) summaryEl.textContent = "T1=0 / T2=0 / T3=0 / T4=0 / T5=0 / 45=0";
    return;
  }

  const buckets = new Map([
    [1, []],
    [2, []],
    [3, []],
    [4, []],
    [5, []],
    ["rl45", []],
    ["other", []]
  ]);

  for (const it of items) {
    const text = it?.text ?? String(it ?? "");
    const tier = (it && typeof it === "object" && "tier" in it && it.tier != null) ? it.tier : getTierFromText(text);

    if (is45CmvRightLaneOnly(text)) {
      buckets.get("rl45").push(text);
      continue;
    }

    if (tier && buckets.has(tier)) buckets.get(tier).push(text);
    else buckets.get("other").push(text);
  }

  // Sort each bucket numerically by route
  for (const [k, arr] of buckets.entries()) {
    arr.sort(sortByRoute);
  }

  // Update the summary next to the "Vehicle Restrictions" title
  const t1 = buckets.get(1).length;
  const t2 = buckets.get(2).length;
  const t3 = buckets.get(3).length;
  const t4 = buckets.get(4).length;
  const t5 = buckets.get(5).length;
  const r45 = buckets.get("rl45").length;

  const summaryEl = document.getElementById("vehSummary");
  if (summaryEl) {
    summaryEl.innerHTML =
      `<span class="t1">T1=${t1}</span> / ` +
      `<span class="t2">T2=${t2}</span> / ` +
      `<span class="t3">T3=${t3}</span> / ` +
      `<span class="t4">T4=${t4}</span> / ` +
      `<span class="t5">T5=${t5}</span> / ` +
      `<span class="rl45">45=${r45}</span>`;
  }

  const tierLabels = {
    1: "Tier 1",
    2: "Tier 2",
    3: "Tier 3",
    4: "Tier 4",
    5: "Tier 5",
    rl45: "45 MPH — CMV Right Lane Only",
    other: "Other / Unclassified vehicle restrictions"
  };

  const headClass = {
    1: "tier1",
    2: "tier2",
    3: "tier3",
    4: "tier4",
    5: "tier5",
    rl45: "rl45",
    other: ""
  };

  // Order: Tier 1–5, then 45 MPH CMV Right Lane Only, then other
  const order = [1,2,3,4,5,"rl45","other"];

  for (const key of order) {
    const arr = buckets.get(key);
    if (!arr || !arr.length) continue;

    const head = document.createElement("div");
    head.className = `grouphead ${headClass[key] || ""}`.trim();
    head.innerHTML = `${tierLabels[key]} <small>(${arr.length})</small>`;
    el.appendChild(head);

    for (const text of arr) {
      const div = document.createElement("div");
      div.className = "item vehicle";
      div.textContent = text;
      el.appendChild(div);
    }
  }
}

async function loadBoard(){
  try {
    let lastRunDt = null;
    let warnings = [];

    // 1) Load last_run.json (written by workflow)
    try {
      const lastRunRes = await fetchFirstWorkingJson(LAST_RUN_FILE);
      const raw =
        lastRunRes.json?.ran_at ||
        lastRunRes.json?.updated ||
        lastRunRes.json?.timestamp ||
        null;

      if (!raw) {
        warnings.push(`data/${LAST_RUN_FILE} missing timestamp (expected ran_at/updated/timestamp).`);
      } else {
        const parsed = new Date(raw);
        if (isNaN(parsed.getTime())) warnings.push(`data/${LAST_RUN_FILE} timestamp invalid: ${raw}`);
        else lastRunDt = parsed;
      }
    } catch (e) {
      warnings.push(`Could not load data/${LAST_RUN_FILE}.`);
    }

    // Update footer
    const upd = document.getElementById("updated");
    if (upd) {
      upd.textContent = lastRunDt
        ? formatDataLastUpdated(lastRunDt)
        : "Data Last Updated: Unknown";
    }

    // If we can't determine last run, treat as RED (not updating)
    if (!lastRunDt) {
      setStatus(
        "err",
        "NOT UPDATING",
        `Dashboard can't determine last run time.\nFix: ensure the workflow writes data/${LAST_RUN_FILE}.`
      );
      return;
    }

    // Stale check (pipeline health)
    const ageMin = minutesAgo(lastRunDt);
    if (ageMin > STALE_MINUTES) {
      setStatus(
        "err",
        "NOT UPDATING",
        `Last successful run was ${ageMin.toFixed(1)} minutes ago.\nThreshold is ${STALE_MINUTES} minutes.\nFix: check GitHub Actions runs/logs.`
      );
      return;
    }

    // 2) Load the data files (failures are ORANGE)
    let closuresJson = null, restr = null;

    // ✅ Closures derived file
    try { closuresJson = (await fetchFirstWorkingJson(CLOSURES_FILE)).json; }
    catch { warnings.push(`Could not load data/${CLOSURES_FILE}.`); }

    // Restrictions file (speed + tier)
    try { restr = (await fetchFirstWorkingJson(RESTR_FILE)).json; }
    catch { warnings.push(`Could not load data/${RESTR_FILE}.`); }

    // Validate expected shapes
    if (closuresJson && !Array.isArray(closuresJson.items)) {
      warnings.push(`data/${CLOSURES_FILE} loaded but missing expected "items" array.`);
    }
    if (restr && !Array.isArray(restr.rows)) {
      warnings.push(`data/${RESTR_FILE} loaded but missing expected "rows" array.`);
    }

    // Build display lists
    const closures = (closuresJson?.items || [])
      .map(it => it?.formatted || "")
      .map(s => String(s).trim())
      .filter(Boolean);

    const restrRows = normalizeRows(restr?.rows)
      .map(cleanLine)
      .filter(s => !isFakeHeaderRow(s));

    const withTiers = applyTierContext(restrRows);

    const speed = withTiers
      .map(r => r.text)
      .filter(isSpeedRestriction)
      .filter(s => !is45CmvRightLaneOnly(s))
      .sort(sortByRoute);

    const vehicle = withTiers.filter(r =>
      is45CmvRightLaneOnly(r.text) ||
      (r.tier != null) ||
      vehiclePanelCandidate(r.text)
    );

    // Render counts
    const cc = document.getElementById("closuresCount");
    const sc = document.getElementById("speedCount");
    const vc = document.getElementById("vehicleCount");
    if (cc) cc.textContent = String(closures.length);
    if (sc) sc.textContent = String(speed.length);
    if (vc) vc.textContent = String(vehicle.length);

    // Render lists
    renderList("closuresList", closures, "");
    renderList("speedList", speed, "speed");
    renderVehicleGrouped("vehicleList", vehicle);

    // Status pill: OK if no warnings, ORANGE if warnings
    if (warnings.length) {
      setStatus(
        "attn",
        "NEEDS ATTENTION",
        `Workflow ran ${ageMin.toFixed(1)} minutes ago, but something needs fixed:\n- ${warnings.join("\n- ")}`
      );
    } else {
      setStatus(
        "ok",
        "OK",
        `Workflow ran ${ageMin.toFixed(1)} minutes ago.\nData files loaded successfully.\nNo action needed.`
      );
    }
  } catch (e) {
    setStatus("err","JS ERROR", e?.stack || e?.message || String(e));
  }
}

loadBoard();
setInterval(loadBoard, REFRESH_MS);
</script>

</body>
</html>
