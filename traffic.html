<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pennsylvania 511 Roadway Status Board</title>

<style>
:root{
  --bg:#0f0f10;
  --panel2:#1d1d1f;
  --border:#2a2a2d;
  --text:#e9e9ea;
  --muted:#a7a7aa;
  --orange:#ffb000;
  --red:#ff2b2b;
  --blue:#00bfff;
  --yellow:#ffe600;
  --green:#29d36a;
}

body{ margin:0; background:var(--bg); color:var(--text); font-family: Arial, Helvetica, sans-serif; }

/* HEADER */
.topbar{
  background:#222;
  border-bottom:2px solid var(--border);
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap: 14px;
}
.title{ font-size:22px; font-weight:700; }
.subtitle{ color:var(--muted); font-size:13px; margin-top: 2px; }
.header-left{ display:flex; flex-direction:column; }

/* Status pill (upper right) */
.status-pill{
  display:inline-flex;
  align-items:center;
  gap:.5rem;
  padding:6px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  border:1px solid rgba(255,255,255,.14);
  user-select:none;
  white-space:nowrap;
}
.status-dot{
  width:10px;
  height:10px;
  border-radius:999px;
  background: currentColor;
  opacity:.95;
  box-shadow: 0 0 0 3px rgba(255,255,255,.06);
}
.status-ok{
  background: rgba(41, 211, 106, .18);
  color: #c9ffcf;
  border-color: rgba(41, 211, 106, .35);
}
.status-attn{
  background: rgba(255, 176, 0, .18);
  color: #ffe6b8;
  border-color: rgba(255, 176, 0, .35);
}
.status-err{
  background: rgba(255, 43, 43, .18);
  color: #ffd0d0;
  border-color: rgba(255, 43, 43, .35);
}

/* ROWS */
.grid{ padding:10px; }
.row{
  background:var(--panel2);
  border:1px solid var(--border);
  border-radius:6px;
  margin-bottom:12px;
  padding:10px 12px;
}

/* TITLES */
.paneltitle{
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid var(--border);
  padding-bottom:8px;
  margin-bottom:8px;
}
.paneltitle .name{ font-size:22px; font-weight:900; color:var(--orange); }
.paneltitle .count{ font-size:18px; color:var(--muted); }

/* ITEMS */
.items{ max-height:45vh; overflow:auto; }
.item{
  padding:10px;
  margin:8px 0;
  background:#141415;
  border:1px solid #232326;
  border-left:7px solid var(--red);
  border-radius:6px;
  font-size:15px;
  line-height:1.25;
  word-break:break-word;
}
.speed .item{ border-left-color: var(--blue); }
.vehicle .item{ border-left-color: var(--yellow); }

/* FOOTER */
.footer{
  position:fixed;
  bottom:8px;
  right:12px;
  color:var(--muted);
  font-size:12px;
  background:rgba(0,0,0,.25);
  padding:6px 10px;
  border:1px solid rgba(255,255,255,.08);
  border-radius:999px;
}
</style>
</head>

<body>

<div class="topbar">
  <div class="header-left">
    <div class="title">Pennsylvania 511 Roadway Status Board</div>
    <div class="subtitle">Automated pull every 5 minutes (GitHub Action).</div>
  </div>

  <!-- Upper-right status pill -->
  <div id="statuspill" class="status-pill status-err" title="Loading…">
    <span class="status-dot"></span>
    <span id="statusline">LOADING…</span>
  </div>
</div>

<div class="grid">

  <div class="row closures">
    <div class="paneltitle">
      <div class="name">Closures</div>
      <div class="count" id="closuresCount">—</div>
    </div>
    <div class="items" id="closuresList"></div>
  </div>

  <div class="row speed">
    <div class="paneltitle">
      <div class="name">Speed Restrictions</div>
      <div class="count" id="speedCount">—</div>
    </div>
    <div class="items" id="speedList"></div>
  </div>

  <div class="row vehicle">
    <div class="paneltitle">
      <div class="name">Vehicle Restrictions</div>
      <div class="count" id="vehicleCount">—</div>
    </div>
    <div class="items" id="vehicleList"></div>
  </div>

</div>

<div class="footer" id="updated">Data Last Updated: —</div>

<script>
const REFRESH_MS = 60000;

// Your existing JSON outputs
const ROAD_FILE  = "road_conditions.json";
const RESTR_FILE = "restrictions.json";

// NEW: file written by the Action each run (see workflow snippet below)
const LAST_RUN_FILE = "last_run.json";

// If last run older than this => RED "NOT UPDATING"
const STALE_MINUTES = 15;

function candidatePaths(filename) {
  const here = new URL(".", window.location.href);
  const parts = location.pathname.split("/").filter(Boolean);
  const repoBase = parts.length ? `/${parts[0]}/` : "/";

  return [
    new URL(`data/${filename}`, here).toString(),
    new URL(`../data/${filename}`, here).toString(),
    new URL(`${repoBase}data/${filename}`, window.location.origin).toString()
  ];
}

async function fetchFirstWorkingJson(filename) {
  let lastErr = null;

  for (const p of candidatePaths(filename)) {
    try {
      const r = await fetch(p, { cache:"no-store" });
      if (!r.ok) { lastErr = new Error(`${r.status} ${r.statusText}`); continue; }
      const json = await r.json();
      return { json, sourceUrl: p };
    } catch (e) {
      lastErr = e;
    }
  }

  throw new Error(`JSON not found: ${filename}` + (lastErr ? ` (last error: ${lastErr})` : ""));
}

function minutesAgo(dt) {
  return (Date.now() - dt.getTime()) / 60000;
}

function setStatus(state, text, hover) {
  const pill = document.getElementById("statuspill");
  const line = document.getElementById("statusline");

  pill.classList.remove("status-ok","status-attn","status-err");
  if (state === "ok") pill.classList.add("status-ok");
  if (state === "attn") pill.classList.add("status-attn");
  if (state === "err") pill.classList.add("status-err");

  line.textContent = text;
  pill.title = hover || "";
}

function normalizeRows(rows) {
  return (rows || [])
    .map(r => Array.isArray(r) ? r.join(" | ") : String(r || ""))
    .map(s => s.trim())
    .filter(Boolean);
}

// Remove junk/boilerplate phrases and trailing “status chips”
function cleanLine(s) {
  let t = s;

  t = t.replace(/^Row Details\s*\|\s*/i, "");
  t = t.replace(/\bOther incident on\b\s*/i, "");

  t = t.replace(/\s*\|\s*I-\d+\s*\|\s*ACTIVE\s*\|\s*View on map\s*$/i, "");
  t = t.replace(/\s*\|\s*US-\d+\s*\|\s*ACTIVE\s*\|\s*View on map\s*$/i, "");
  t = t.replace(/\s*\|\s*PA-\d+\s*\|\s*ACTIVE\s*\|\s*View on map\s*$/i, "");
  t = t.replace(/\s*\|\s*ACTIVE\s*\|\s*View on map\s*$/i, "");
  t = t.replace(/\s*\|\s*View on map\s*$/i, "");

  t = t.replace(/\s*\|\s*\|\s*/g, " | ");
  t = t.replace(/\s{2,}/g, " ");

  return t.trim();
}

function isFakeHeaderRow(s) {
  const t = s.trim().toLowerCase();

  if (t === "speed restrictions") return true;
  if (t === "vehicle restrictions") return true;
  if (t === "restrictions") return true;

  const hasRoadHint = /(i-\d+|us-\d+|pa-\d+|turnpike|route|sr\s*\d+|exit)/i.test(s);
  if (!hasRoadHint && t.length <= 25) return true;

  const hasDigit = /\d/.test(s);
  if (!hasDigit && !hasRoadHint) return true;

  return false;
}

function renderList(elId, items, kind) {
  const el = document.getElementById(elId);
  el.innerHTML = "";

  if (!items.length) {
    const div = document.createElement("div");
    div.className = `item ${kind || ""}`;
    div.style.borderLeftColor = "var(--green)";
    div.textContent = "None currently reported";
    el.appendChild(div);
    return;
  }

  items.forEach(text => {
    const div = document.createElement("div");
    div.className = `item ${kind || ""}`;
    div.textContent = text;
    el.appendChild(div);
  });
}

function isClosure(text) {
  return /\b(closed|closure)\b/i.test(text);
}
function isSpeedRestriction(text) {
  const hasRoad = /(i-\d+|us-\d+|pa-\d+|turnpike|route|sr\s*\d+|exit)/i.test(text);
  const hasSpeed = /\b(mph|speed)\b/i.test(text);
  return hasSpeed && hasRoad;
}
function isTierRestriction(text) {
  const tierish = /\btier\s*[1-3]\b/i.test(text);
  const permit = /\b(no permit travel|permit travel)\b/i.test(text);
  const commercial = /\b(commercial vehicles?|cmv|trucks?)\b/i.test(text);
  const hasRoad = /(i-\d+|us-\d+|pa-\d+|turnpike|route|sr\s*\d+|exit)/i.test(text);
  return hasRoad && (tierish || permit || commercial);
}

function formatDataLastUpdated(dt) {
  if (!dt) return "Data Last Updated: —";
  return "Data Last Updated: " + dt.toLocaleString();
}

async function loadBoard(){
  // We will compute a "pipeline health" state
  // based on last_run.json + ability to load the data files.
  let lastRunDt = null;
  let warnings = [];

  try {
    // 1) Read last run time (Action writes this file)
    const lastRunRes = await fetchFirstWorkingJson(LAST_RUN_FILE);

    // Support a few common keys so you have flexibility:
    const raw =
      lastRunRes.json?.ran_at ||
      lastRunRes.json?.updated ||
      lastRunRes.json?.timestamp ||
      null;

    if (!raw) {
      warnings.push(`"${LAST_RUN_FILE}" is missing a timestamp field (expected ran_at/updated/timestamp).`);
    } else {
      const parsed = new Date(raw);
      if (isNaN(parsed.getTime())) {
        warnings.push(`"${LAST_RUN_FILE}" timestamp is invalid: ${raw}`);
      } else {
        lastRunDt = parsed;
      }
    }
  } catch (e) {
    warnings.push(`Could not load data/${LAST_RUN_FILE}.`);
  }

  // 2) Use lastRunDt to set footer + stale status
  if (lastRunDt) {
    document.getElementById("updated").textContent = formatDataLastUpdated(lastRunDt);
  } else {
    document.getElementById("updated").textContent = "Data Last Updated: Unknown";
  }

  // 3) If stale => RED immediately (even if old JSON is still present)
  if (!lastRunDt) {
    setStatus(
      "err",
      "NOT UPDATING",
      `Dashboard cannot determine last run time.\nFix: ensure data/${LAST_RUN_FILE} is being written by the workflow.`
    );
    return;
  }

  const ageMin = minutesAgo(lastRunDt);
  if (ageMin > STALE_MINUTES) {
    setStatus(
      "err",
      "NOT UPDATING",
      `Last run is ${ageMin.toFixed(1)} minutes ago (threshold ${STALE_MINUTES}m).\nFix: check GitHub Actions runs/logs, and confirm the scrape job is succeeding.`
    );
    return;
  }

  // 4) Now load actual data files; failures here become ORANGE (needs attention)
  let road, restr;
  try {
    const roadRes = await fetchFirstWorkingJson(ROAD_FILE);
    road = roadRes.json;
  } catch (e) {
    warnings.push(`Could not load data/${ROAD_FILE}.`);
  }

  try {
    const restrRes = await fetchFirstWorkingJson(RESTR_FILE);
    restr = restrRes.json;
  } catch (e) {
    warnings.push(`Could not load data/${RESTR_FILE}.`);
  }

  // If either file missing => ORANGE, but keep rendering what we can
  const roadRows = normalizeRows(road?.rows).map(cleanLine).filter(s => !isFakeHeaderRow(s));
  const restrRows = normalizeRows(restr?.rows).map(cleanLine).filter(s => !isFakeHeaderRow(s));

  // Expected structure checks (optional, but makes “orange” meaningful)
  if (road && !Array.isArray(road.rows)) warnings.push(`data/${ROAD_FILE} loaded but missing expected "rows" array.`);
  if (restr && !Array.isArray(restr.rows)) warnings.push(`data/${RESTR_FILE} loaded but missing expected "rows" array.`);

  const closures = roadRows.filter(isClosure);
  const speed = restrRows.filter(isSpeedRestriction);
  const vehicle = restrRows.filter(isTierRestriction);

  // Update counts
  document.getElementById("closuresCount").textContent = String(closures.length);
  document.getElementById("speedCount").textContent = String(speed.length);
  document.getElementById("vehicleCount").textContent = String(vehicle.length);

  // Render
  renderList("closuresList", closures, "");
  renderList("speedList", speed, "speed");
  renderList("vehicleList", vehicle, "vehicle");

  // 5) Health status (NOT incident status)
  if (warnings.length) {
    setStatus(
      "attn",
      "NEEDS ATTENTION",
      `Workflow ran recently (${ageMin.toFixed(1)}m ago), but something needs fixed:\n- ${warnings.join("\n- ")}\n\nFix: check the scrape workflow logs and ensure it writes JSON outputs + ${LAST_RUN_FILE}.`
    );
  } else {
    setStatus(
      "ok",
      "OK",
      `Workflow ran ${ageMin.toFixed(1)} minutes ago.\nData files loaded successfully.\nNo action needed.`
    );
  }
}

loadBoard();
setInterval(loadBoard, REFRESH_MS);
</script>

</body>
</html>
