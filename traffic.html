<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PA 511 Status Board</title>

<style>
:root{
  --bg:#0f0f10;
  --panel2:#1d1d1f;
  --border:#2a2a2d;
  --text:#e9e9ea;
  --muted:#a7a7aa;
  --orange:#ffb000;
  --red:#ff2b2b;
  --blue:#00bfff;
  --yellow:#ffe600;
  --green:#29d36a;
}

body{ margin:0; background:var(--bg); color:var(--text); font-family: Arial, Helvetica, sans-serif; }

/* HEADER */
.topbar{
  background:#222;
  border-bottom:2px solid var(--border);
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.title{ font-size:22px; font-weight:700; }
.subtitle{ color:var(--muted); font-size:13px; }

/* ROWS */
.grid{ padding:10px; }
.row{
  background:var(--panel2);
  border:1px solid var(--border);
  border-radius:6px;
  margin-bottom:12px;
  padding:10px 12px;
}

/* TITLES */
.paneltitle{
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid var(--border);
  padding-bottom:8px;
  margin-bottom:8px;
}
.paneltitle .name{ font-size:22px; font-weight:900; color:var(--orange); }
.paneltitle .count{ font-size:18px; color:var(--muted); }

/* ITEMS */
.items{ max-height:45vh; overflow:auto; }
.item{
  padding:10px;
  margin:8px 0;
  background:#141415;
  border:1px solid #232326;
  border-left:7px solid var(--red);
  border-radius:6px;
  font-size:15px;
  line-height:1.25;
  word-break:break-word;
}
.speed .item{ border-left-color: var(--blue); }
.vehicle .item{ border-left-color: var(--yellow); }

/* FOOTER */
.footer{
  position:fixed;
  bottom:8px;
  right:12px;
  color:var(--muted);
  font-size:12px;
  background:rgba(0,0,0,.25);
  padding:6px 10px;
  border:1px solid rgba(255,255,255,.08);
  border-radius:999px;
}
</style>
</head>

<body>

<div class="topbar">
  <div class="title">PA 511 Status Board</div>
  <div class="subtitle" id="statusline">Loading…</div>
</div>

<div class="grid">

  <div class="row closures">
    <div class="paneltitle">
      <div class="name">Closures</div>
      <div class="count" id="closuresCount">—</div>
    </div>
    <div class="items" id="closuresList"></div>
  </div>

  <div class="row speed">
    <div class="paneltitle">
      <div class="name">Speed Restrictions</div>
      <div class="count" id="speedCount">—</div>
    </div>
    <div class="items" id="speedList"></div>
  </div>

  <div class="row vehicle">
    <div class="paneltitle">
      <div class="name">Vehicle Restrictions</div>
      <div class="count" id="vehicleCount">—</div>
    </div>
    <div class="items" id="vehicleList"></div>
  </div>

</div>

<div class="footer" id="updated">Last Updated: —</div>

<script>
const REFRESH_MS = 60000;
const ROAD_FILE = "road_conditions.json";
const RESTR_FILE = "restrictions.json";

function candidatePaths(filename) {
  const here = new URL(".", window.location.href);
  const parts = location.pathname.split("/").filter(Boolean);
  const repoBase = parts.length ? `/${parts[0]}/` : "/";

  return [
    new URL(`data/${filename}`, here).toString(),
    new URL(`../data/${filename}`, here).toString(),
    new URL(`${repoBase}data/${filename}`, window.location.origin).toString()
  ];
}

async function fetchFirstWorkingJson(filename) {
  for (const p of candidatePaths(filename)) {
    try {
      const r = await fetch(p, { cache:"no-store" });
      if (!r.ok) continue;
      return await r.json();
    } catch {}
  }
  throw new Error(`JSON not found: ${filename}`);
}

function normalizeRows(rows) {
  return (rows || [])
    .map(r => Array.isArray(r) ? r.join(" | ") : String(r || ""))
    .map(s => s.trim())
    .filter(Boolean);
}

// Remove junk/boilerplate phrases and trailing “status chips”
function cleanLine(s) {
  let t = s;

  // Common prefix cleanup
  t = t.replace(/^Row Details\s*\|\s*/i, "");
  t = t.replace(/\bOther incident on\b\s*/i, ""); // “Other incident on I-81…” -> “I-81…”

  // Remove trailing “chips” like “| I-81 | ACTIVE | View on map”
  // (works even if route varies)
  t = t.replace(/\s*\|\s*I-\d+\s*\|\s*ACTIVE\s*\|\s*View on map\s*$/i, "");
  t = t.replace(/\s*\|\s*US-\d+\s*\|\s*ACTIVE\s*\|\s*View on map\s*$/i, "");
  t = t.replace(/\s*\|\s*PA-\d+\s*\|\s*ACTIVE\s*\|\s*View on map\s*$/i, "");
  t = t.replace(/\s*\|\s*ACTIVE\s*\|\s*View on map\s*$/i, "");
  t = t.replace(/\s*\|\s*View on map\s*$/i, "");

  // Collapse any doubled separators leftover
  t = t.replace(/\s*\|\s*\|\s*/g, " | ");
  t = t.replace(/\s{2,}/g, " ");

  return t.trim();
}

// Filter out “section/header” rows that aren’t real events
function isFakeHeaderRow(s) {
  const t = s.trim().toLowerCase();

  // 511PA sometimes includes a row that is literally just a category label
  if (t === "speed restrictions") return true;
  if (t === "vehicle restrictions") return true;
  if (t === "restrictions") return true;

  // If it’s super short and has no roadway keywords, it’s probably not an event
  const hasRoadHint = /(i-\d+|us-\d+|pa-\d+|turnpike|route|sr\s*\d+|exit)/i.test(s);
  if (!hasRoadHint && t.length <= 25) return true;

  // If it contains only generic words (no digits/exits/locations), treat as header-ish
  const hasDigit = /\d/.test(s);
  if (!hasDigit && !hasRoadHint) return true;

  return false;
}

function renderList(elId, items, kind) {
  const el = document.getElementById(elId);
  el.innerHTML = "";

  if (!items.length) {
    const div = document.createElement("div");
    div.className = `item ${kind || ""}`;
    div.style.borderLeftColor = "var(--green)";
    div.textContent = "None currently reported";
    el.appendChild(div);
    return;
  }

  items.forEach(text => {
    const div = document.createElement("div");
    div.className = `item ${kind || ""}`;
    div.textContent = text;
    el.appendChild(div);
  });
}

function isClosure(text) {
  return /\b(closed|closure)\b/i.test(text);
}

// Keep speed strict so the category header doesn’t sneak in
function isSpeedRestriction(text) {
  // require some “event-ish” detail (road+digit or “speed limit has been reduced”)
  const hasRoad = /(i-\d+|us-\d+|pa-\d+|turnpike|route|sr\s*\d+|exit)/i.test(text);
  const hasSpeed = /\b(mph|speed)\b/i.test(text);
  return hasSpeed && hasRoad;
}

// Tier restrictions (winter) — do NOT treat generic “restriction” as enough
function isTierRestriction(text) {
  // common patterns: “Tier 1”, “Tier 2”, “Tier 3”, “Restrictions lifted”, “No permit travel”, “Commercial vehicle restriction”
  const tierish = /\btier\s*[1-3]\b/i.test(text);
  const permit = /\b(no permit travel|permit travel)\b/i.test(text);
  const commercial = /\b(commercial vehicles?|cmv|trucks?)\b/i.test(text);
  const hasRoad = /(i-\d+|us-\d+|pa-\d+|turnpike|route|sr\s*\d+|exit)/i.test(text);

  // must be tier/permit/commercial + a roadway reference
  return hasRoad && (tierish || permit || commercial);
}

async function loadBoard(){
  try{
    const road = await fetchFirstWorkingJson(ROAD_FILE);
    const restr = await fetchFirstWorkingJson(RESTR_FILE);

    // Build lists
    const roadRows = normalizeRows(road.rows)
      .map(cleanLine)
      .filter(s => !isFakeHeaderRow(s));

    const restrRows = normalizeRows(restr.rows)
      .map(cleanLine)
      .filter(s => !isFakeHeaderRow(s));

    const closures = roadRows.filter(isClosure);

    const speed = restrRows
      .filter(isSpeedRestriction);

    const vehicle = restrRows
      .filter(isTierRestriction);

    // Update counts
    document.getElementById("closuresCount").textContent = closures.length;
    document.getElementById("speedCount").textContent = speed.length;
    document.getElementById("vehicleCount").textContent = vehicle.length;

    // Render
    renderList("closuresList", closures, "");
    renderList("speedList", speed, "speed");
    renderList("vehicleList", vehicle, "vehicle");

    document.getElementById("updated").textContent =
      "Last Updated: " + new Date().toLocaleString();

    document.getElementById("statusline").textContent = "OK";
  } catch(e) {
    console.error(e);
    document.getElementById("statusline").textContent = "ERROR loading data";
  }
}

loadBoard();
setInterval(loadBoard, REFRESH_MS);
</script>

</body>
</html>
