<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pennsylvania Weather Hazard Overview</title>

  <style>
    :root{
      color-scheme: light;

      --bg:#ffffff;
      --text:#111111;
      --muted:#555555;

      --border:#333333;
      --borderSoft:#cfcfcf;

      --panelBg:#ffffff;
      --panelHeadBg:#f0f0f0;

      --btnBg:#ffffff;
      --btnBgHover:#f3f3f3;

      --pillBg:#f6f6f6;

      --changesBg:#f7fbff;
      --changesBorder:#b7d5ff;
      --changesTitle:#0b3d91;

      --okBg:#f1fff3;
      --okBorder:#8ad39a;

      --warnBg:#fff7e6;
      --warnBorder:#f2c45f;

      --badBg:#fff1f1;
      --badBorder:#e08a8a;

      --modalBackdrop:rgba(0,0,0,0.55);
      --modalBg:#ffffff;
      --modalText:#111111;

      --shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    body.dark{
      color-scheme: dark;

      --bg:#0f1115;
      --text:#e9e9ea;
      --muted:#b6b6b7;

      --border:#8f8f90;
      --borderSoft:#30343a;

      --panelBg:#141821;
      --panelHeadBg:#1b2030;

      --btnBg:#141821;
      --btnBgHover:#1c2333;

      --pillBg:#111722;

      --changesBg:#101a2c;
      --changesBorder:#2f5fb8;
      --changesTitle:#9ec1ff;

      --okBg:#102016;
      --okBorder:#2f8a4c;

      --warnBg:#2a200f;
      --warnBorder:#b98a2d;

      --badBg:#2a1414;
      --badBorder:#b35a5a;

      --modalBackdrop:rgba(0,0,0,0.7);
      --modalBg:#141821;
      --modalText:#e9e9ea;

      --shadow: 0 12px 30px rgba(0,0,0,0.35);
    }

    *{ box-sizing:border-box; }
    body{
      margin:16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    h1{
      margin:0 0 10px 0;
      font-size: 1.55rem;
      font-weight: 700;
    }

    /* Top controls row */
    .topRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    .leftCluster{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      max-width: 1200px;
    }

    .metaLine{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size: 0.95rem;
      white-space: nowrap;
    }

    button{
      font: inherit;
      border:1px solid var(--border);
      background:var(--btnBg);
      color:var(--text);
      border-radius:6px;
      padding:6px 12px;
      cursor:pointer;
    }
    button:hover{ background:var(--btnBgHover); }
    button:active{ transform: translateY(1px); }

    .rightCluster{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-left:auto;
    }

    /* Changes ticker box */
    .changesBox{
      min-width: 360px;
      max-width: 760px;
      flex: 1 1 420px;
      border:1px solid var(--changesBorder);
      background: var(--changesBg);
      border-radius:10px;
      padding:8px 10px;
    }

    .changesHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .changesTitle{
      font-weight:700;
      color: var(--changesTitle);
      font-size: 0.95rem;
      letter-spacing: 0.2px;
    }

    .changesExpandBtn{
      padding:4px 10px;
      font-size: 0.9rem;
      border-radius: 999px;
    }

    /* The visible window */
    .changesTicker{
      position:relative;
      height: 44px;                 /* controls ‚Äúbox‚Äù height */
      overflow:hidden;
      border:1px solid var(--borderSoft);
      border-radius:8px;
      background: var(--pillBg);
      padding:6px 10px;
    }

    /* Track that scrolls upward */
    .changesTrack{
      display:flex;
      flex-direction:column;
      gap:6px;
      will-change: transform;
    }

    .changesItem{
      display:flex;
      gap:8px;
      align-items:flex-start;
      font-size:0.92rem;
      line-height:1.15rem;
      color: var(--text);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .tag{
      flex: 0 0 auto;
      font-size: 0.8rem;
      padding: 1px 8px;
      border-radius: 999px;
      border: 1px solid var(--borderSoft);
      background: transparent;
      color: var(--muted);
      line-height: 1.2rem;
    }

    .tag.ok{ background: var(--okBg); border-color: var(--okBorder); color: var(--text); }
    .tag.warn{ background: var(--warnBg); border-color: var(--warnBorder); color: var(--text); }
    .tag.bad{ background: var(--badBg); border-color: var(--badBorder); color: var(--text); }

    /* Scroll animation class (enabled only when >1 item) */
    .scrolling{
      animation: tickerUp linear infinite;
    }
    /* Pause when user hovers to read */
    .changesTicker:hover .scrolling{
      animation-play-state: paused;
    }

    @keyframes tickerUp{
      from { transform: translateY(0); }
      to   { transform: translateY(var(--tickerEnd)); }
    }

    /* Panels */
    .panel{
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
      background: var(--panelBg);
    }
    .panelHead{
      background: var(--panelHeadBg);
      padding:8px 10px;
      font-weight:700;
      border-bottom:1px solid var(--border);
    }
    .panelBody{
      padding:10px;
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:stretch;
    }

    .frameWrap{
      border:1px solid var(--borderSoft);
      border-radius:10px;
      overflow:hidden;
      background: var(--bg);
      min-height: 420px;
    }
    iframe{
      width:100%;
      height: 520px;
      border:0;
      display:block;
      background: var(--bg);
    }

    @media (max-width: 1100px){
      .twoCol{ grid-template-columns: 1fr; }
      iframe{ height: 460px; }
      .changesBox{ min-width: 300px; }
    }

    /* Modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background: var(--modalBackdrop);
      z-index: 1000;
    }

    .modal{
      position:fixed;
      inset:0;
      z-index: 1001;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }

    .modalCard{
      width: min(900px, 96vw);
      max-height: min(78vh, 700px);
      background: var(--modalBg);
      color: var(--modalText);
      border-radius: 14px;
      border: 1px solid var(--borderSoft);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .modalHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 12px 14px;
      border-bottom:1px solid var(--borderSoft);
      background: var(--panelHeadBg);
    }

    .modalTitle{ font-weight: 800; font-size: 1.05rem; }
    .modalSub{ color: var(--muted); font-size: 0.95rem; margin-top:2px; }

    .modalCloseBtn{
      border-radius: 10px;
      padding: 6px 10px;
    }

    .modalBody{
      padding: 12px 14px;
      overflow:auto;
    }

    .changesList{
      margin:0;
      padding-left: 18px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .footNote{
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="topRow">
    <div style="min-width:260px;">
      <h1>Pennsylvania Weather Hazard Overview</h1>
    </div>

    <div class="leftCluster">
      <div class="metaLine">
        <span>Auto-refresh: <strong id="autoRefreshLabel">5 min</strong></span>
        <button id="refreshBtn" type="button">Refresh</button>
        <span>Last updated: <strong id="lastUpdated">--/--/--, --:--:--</strong></span>
        <span>| Alert Groups: <strong id="alertGroups">0</strong></span>
      </div>

      <!-- Recent Changes Ticker Box -->
      <div class="changesBox" aria-label="Recent changes">
        <div class="changesHeader">
          <span class="changesTitle">Recent changes</span>
          <button id="changesExpandBtn" class="changesExpandBtn" type="button" aria-haspopup="dialog" aria-controls="changesModal">
            Expand
          </button>
        </div>

        <div class="changesTicker" role="status" aria-live="polite" aria-atomic="true">
          <div class="changesTrack" id="changesTrack"></div>
        </div>
      </div>
    </div>

    <div class="rightCluster">
      <button id="themeBtn" type="button" title="Toggle dark mode">üåô Dark</button>
    </div>
  </div>

  <div class="panel">
    <div class="panelHead">PA Alert Map &amp; Radar</div>
    <div class="panelBody">
      <div class="twoCol">
        <div class="frameWrap" aria-label="NWS Watches Warnings Advisories Map">
          <!-- Replace with your preferred NWS WWA map embed URL -->
          <iframe
            src="https://www.weather.gov/images/crh/noc/wwa_pa.png"
            title="NWS Current Watches, Warnings, and Advisories Map (PA)">
          </iframe>
        </div>

        <div class="frameWrap" aria-label="Radar Map">
          <!-- Replace with your preferred radar embed URL (Windy, NWS radar, etc.) -->
          <iframe
            src="https://www.windy.com/?radar,40.95,-77.76,7"
            title="Radar">
          </iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="changesModalBackdrop" hidden></div>
  <div class="modal" id="changesModal" role="dialog" aria-modal="true" aria-labelledby="changesModalTitle" hidden>
    <div class="modalCard">
      <div class="modalHeader">
        <div>
          <div id="changesModalTitle" class="modalTitle">Recent changes</div>
          <div class="modalSub" id="changesModalSub">Since last refresh</div>
        </div>
        <button class="modalCloseBtn" id="changesCloseBtn" type="button" aria-label="Close">‚úï</button>
      </div>

      <div class="modalBody">
        <ul class="changesList" id="changesModalList"></ul>
        <div class="footNote" id="changesFootNote"></div>
      </div>
    </div>
  </div>

  <script>
    /******************************************************************
     * LATE-NIGHT FRIENDLY FULL PAGE:
     * - Recent changes box that scrolls (pauses on hover)
     * - Expand button opens modal with full list
     * - Auto-refresh timer + manual refresh
     *
     * INTEGRATION POINT:
     * Replace getCurrentState() with your real data pull + parsing.
     * The change detection works off a snapshot of IDs + key fields.
     ******************************************************************/

    // ======== Settings ========
    const AUTO_REFRESH_MINUTES = 5;
    const MAX_TICKER_ITEMS = 6;      // how many to show in the scrolling box
    const MAX_HISTORY_LINES = 50;    // how many lines to keep for the modal

    // ======== State ========
    let lastSnapshot = {};           // keyed by alert id
    let changeHistory = [];          // rolling list for modal (most recent first)
    let lastRefreshHadChanges = false;

    // ======== DOM ========
    const autoRefreshLabelEl = document.getElementById("autoRefreshLabel");
    const refreshBtn = document.getElementById("refreshBtn");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const alertGroupsEl = document.getElementById("alertGroups");

    const changesTrackEl = document.getElementById("changesTrack");
    const changesExpandBtn = document.getElementById("changesExpandBtn");

    const modalBackdrop = document.getElementById("changesModalBackdrop");
    const modalEl = document.getElementById("changesModal");
    const modalListEl = document.getElementById("changesModalList");
    const modalSubEl = document.getElementById("changesModalSub");
    const modalCloseBtn = document.getElementById("changesCloseBtn");
    const changesFootNote = document.getElementById("changesFootNote");

    const themeBtn = document.getElementById("themeBtn");

    // ======== Helpers ========
    function pad2(n){ return String(n).padStart(2,"0"); }

    // mm/dd/yy, hh:mm:ss AM/PM
    function formatTimestamp(d){
      const mm = pad2(d.getMonth()+1);
      const dd = pad2(d.getDate());
      const yy = pad2(d.getFullYear()%100);

      let h = d.getHours();
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12; if (h === 0) h = 12;

      const hh = pad2(h);
      const mi = pad2(d.getMinutes());
      const ss = pad2(d.getSeconds());
      return `${mm}/${dd}/${yy}, ${hh}:${mi}:${ss} ${ampm}`;
    }

    function setTheme(isDark){
      document.body.classList.toggle("dark", isDark);
      themeBtn.textContent = isDark ? "‚òÄÔ∏è Light" : "üåô Dark";
      localStorage.setItem("sa_theme_dark", isDark ? "1" : "0");
    }

    function loadTheme(){
      const saved = localStorage.getItem("sa_theme_dark");
      setTheme(saved === "1");
    }

    // Creates a ‚Äútag‚Äù based on change type
    function tagClass(kind){
      if (kind === "NO_CHANGE") return "ok";
      if (kind === "NEW" || kind === "UPGRADED") return "warn";
      if (kind === "CLEARED" || kind === "DOWNGRADED") return "bad";
      return "";
    }

    // ======== Scrolling ticker render ========
    function renderTicker(lines){
      changesTrackEl.classList.remove("scrolling");
      changesTrackEl.style.removeProperty("--tickerEnd");
      changesTrackEl.innerHTML = "";

      const useLines = lines.slice(0, MAX_TICKER_ITEMS);

      // Empty / no-change state
      if (!useLines.length){
        const item = document.createElement("div");
        item.className = "changesItem";
        item.innerHTML = `<span class="tag ok">OK</span><span>No changes since last refresh</span>`;
        changesTrackEl.appendChild(item);
        return;
      }

      // Build items
      for (const ln of useLines){
        const item = document.createElement("div");
        item.className = "changesItem";
        item.title = ln.text;

        const cls = tagClass(ln.kind);
        item.innerHTML = `<span class="tag ${cls}">${ln.label}</span><span>${escapeHtml(ln.text)}</span>`;
        changesTrackEl.appendChild(item);
      }

      // If more than 1 line, enable smooth upward scroll by duplicating content
      if (useLines.length > 1){
        // Duplicate for seamless loop
        for (const ln of useLines){
          const item = document.createElement("div");
          item.className = "changesItem";
          item.title = ln.text;

          const cls = tagClass(ln.kind);
          item.innerHTML = `<span class="tag ${cls}">${ln.label}</span><span>${escapeHtml(ln.text)}</span>`;
          changesTrackEl.appendChild(item);
        }

        // After layout, compute scroll distance and duration
        requestAnimationFrame(() => {
          const halfHeight = Math.floor(changesTrackEl.scrollHeight / 2);
          // Negative translateY to move up by half the track
          changesTrackEl.style.setProperty("--tickerEnd", `-${halfHeight}px`);

          // Duration: tune so it feels readable
          // ~2.5 seconds per line, with a minimum
          const seconds = Math.max(10, useLines.length * 2.5);
          changesTrackEl.style.animationDuration = `${seconds}s`;
          changesTrackEl.classList.add("scrolling");
        });
      }
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ======== Modal ========
    function openModal(){
      modalBackdrop.hidden = false;
      modalEl.hidden = false;
      // focus close button for keyboard users
      modalCloseBtn.focus();
      document.addEventListener("keydown", onModalKeydown, { passive: true });
    }

    function closeModal(){
      modalBackdrop.hidden = true;
      modalEl.hidden = true;
      document.removeEventListener("keydown", onModalKeydown);
    }

    function onModalKeydown(e){
      if (e.key === "Escape") closeModal();
    }

    function renderModal(){
      modalListEl.innerHTML = "";

      if (!changeHistory.length){
        const li = document.createElement("li");
        li.textContent = "No changes logged yet.";
        modalListEl.appendChild(li);
      } else {
        for (const line of changeHistory){
          const li = document.createElement("li");
          li.textContent = line;
          modalListEl.appendChild(li);
        }
      }

      changesFootNote.textContent =
        lastRefreshHadChanges
          ? "Tip: Hover the ticker to pause the scroll."
          : "No changes detected on the most recent refresh.";
    }

    // ======== Change detection ========
    // Snapshot format: { [id]: { type, area, severityRank } }
    // You can add more fields if you want county lists, etc.
    function diffSnapshots(prev, cur){
      const out = [];

      // New or changed
      for (const id of Object.keys(cur)){
        if (!prev[id]){
          out.push({ kind:"NEW", label:"NEW", text:`${cur[id].type} ‚Äì ${cur[id].area}` });
        } else {
          // Upgrade/downgrade by severityRank if type changed
          const p = prev[id], c = cur[id];
          if (p.type !== c.type){
            // severityRank is optional; if present, try to classify
            if (typeof p.severityRank === "number" && typeof c.severityRank === "number"){
              if (c.severityRank > p.severityRank){
                out.push({ kind:"UPGRADED", label:"UP", text:`Upgraded: ${p.type} ‚Üí ${c.type} ‚Äì ${c.area}` });
              } else if (c.severityRank < p.severityRank){
                out.push({ kind:"DOWNGRADED", label:"DN", text:`Downgraded: ${p.type} ‚Üí ${c.type} ‚Äì ${c.area}` });
              } else {
                out.push({ kind:"CHANGED", label:"CHG", text:`Changed: ${p.type} ‚Üí ${c.type} ‚Äì ${c.area}` });
              }
            } else {
              out.push({ kind:"CHANGED", label:"CHG", text:`Changed: ${p.type} ‚Üí ${c.type} ‚Äì ${c.area}` });
            }
          }
        }
      }

      // Cleared
      for (const id of Object.keys(prev)){
        if (!cur[id]){
          out.push({ kind:"CLEARED", label:"CLR", text:`Cleared: ${prev[id].type} ‚Äì ${prev[id].area}` });
        }
      }

      return out;
    }

    // ======== Data fetch (REPLACE THIS) ========
    // This stub simulates state changing so you can see the ticker work.
    // Replace with your real alert fetch, then build snapshot from the data.
    let demoTick = 0;

    async function getCurrentState(){
      // ---- DEMO DATA ONLY ----
      demoTick++;

      const base = {
        "A1": { type:"Winter Weather Advisory", area:"Northern Tier", severityRank: 1 },
        "A2": { type:"Small Craft Advisory", area:"Lake Erie", severityRank: 1 },
        "A3": { type:"Extreme Cold Warning", area:"Poconos", severityRank: 3 }
      };

      // mutate over time to show changes
      if (demoTick % 3 === 0){
        base["A4"] = { type:"Wind Chill Advisory", area:"Central Mountains", severityRank: 1 };
      }
      if (demoTick % 4 === 0){
        delete base["A2"];
      }
      if (demoTick % 5 === 0){
        base["A1"] = { type:"Winter Storm Warning", area:"Northern Tier", severityRank: 3 }; // upgrade
      }

      // ‚Äúalert groups‚Äù count example (you can compute however you do)
      const alertGroups = Object.keys(base).length;

      return {
        snapshot: base,
        alertGroups
      };
    }

    // ======== Refresh workflow ========
    async function doRefresh(){
      refreshBtn.disabled = true;

      try{
        const now = new Date();
        lastUpdatedEl.textContent = formatTimestamp(now);

        const { snapshot, alertGroups } = await getCurrentState();
        alertGroupsEl.textContent = String(alertGroups);

        const changes = diffSnapshots(lastSnapshot, snapshot);
        lastRefreshHadChanges = changes.length > 0;

        // Update rolling history for modal
        if (changes.length){
          const stamp = formatTimestamp(now);
          // newest first; prefix with time so it reads like a log
          const lines = changes.map(c => `[${stamp}] ${c.label}: ${c.text}`);
          changeHistory = [...lines, ...changeHistory].slice(0, MAX_HISTORY_LINES);
        } else {
          // If no changes, still keep a single ‚Äúno change‚Äù marker optionally:
          // changeHistory = [`[${formatTimestamp(now)}] OK: No changes`, ...changeHistory].slice(0, MAX_HISTORY_LINES);
        }

        // Render ticker (convert to display objects)
        const tickerLines = changes.length
          ? changes
          : []; // empty -> renders "No changes"

        renderTicker(tickerLines);
        renderModal();

        // Store for next diff
        lastSnapshot = structuredClone(snapshot);

      } catch(err){
        // If your live fetch fails, show it plainly in the ticker + modal
        const now = new Date();
        lastUpdatedEl.textContent = formatTimestamp(now);

        const msg = `Data refresh error: ${err?.message || err}`;
        renderTicker([{ kind:"DOWNGRADED", label:"ERR", text: msg }]);

        changeHistory = [`[${formatTimestamp(now)}] ERR: ${msg}`, ...changeHistory].slice(0, MAX_HISTORY_LINES);
        renderModal();
      } finally{
        refreshBtn.disabled = false;
      }
    }

    // ======== Wire up UI ========
    refreshBtn.addEventListener("click", doRefresh);

    changesExpandBtn.addEventListener("click", () => {
      renderModal();
      openModal();
    });

    modalCloseBtn.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", closeModal);

    themeBtn.addEventListener("click", () => {
      const isDark = !document.body.classList.contains("dark");
      setTheme(isDark);
    });

    // ======== Init ========
    autoRefreshLabelEl.textContent = `${AUTO_REFRESH_MINUTES} min`;
    loadTheme();

    // Initial render
    doRefresh();

    // Auto refresh
    setInterval(doRefresh, AUTO_REFRESH_MINUTES * 60 * 1000);
  </script>
</body>
</html>
