<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pennsylvania Weather Hazard Overview</title>

<style>
:root{
  color-scheme: light;
  --bg:#ffffff;
  --text:#111111;
  --muted:#555555;
  --border:#333333;
  --borderSoft:#cccccc;
  --tableHeadBg:#f0f0f0;
  --btnBg:#ffffff;
  --btnBgHover:#f3f3f3;

  --watchBg: rgba(255,165,0,0.5);
  --warningBg: rgba(220,38,38,0.5);
  --advBg: rgba(255,235,59,0.55);

  --mapFallbackBg:#f6f6f6;
  --mapFallbackBorder:#999999;

  /* Recent changes */
  --changesBg:#f7fbff;
  --changesBorder:#b7d5ff;
  --changesTitle:#0b3d91;
  --pillBg:#f6f6f6;

  --okBg:#f1fff3;
  --okBorder:#8ad39a;

  --warnBg:#fff7e6;
  --warnBorder:#f2c45f;

  --badBg:#fff1f1;
  --badBorder:#e08a8a;

  --modalBackdrop:rgba(0,0,0,0.55);
  --modalBg:#ffffff;
  --modalText:#111111;
  --shadow: 0 10px 26px rgba(0,0,0,0.18);
}

:root[data-theme="dark"]{
  color-scheme: dark;
  --bg:#0f1216;
  --text:#e9eef5;
  --muted:#a8b2bf;
  --border:#2b3646;
  --borderSoft:#2b3646;
  --tableHeadBg:#1b2330;
  --btnBg:#171c22;
  --btnBgHover:#232b36;

  --watchBg: rgba(255,165,0,0.35);
  --warningBg: rgba(220,38,38,0.35);
  --advBg: rgba(255,235,59,0.25);

  --mapFallbackBg:#0f141b;
  --mapFallbackBorder:#2b3646;

  --changesBg:#101a2c;
  --changesBorder:#2f5fb8;
  --changesTitle:#9ec1ff;
  --pillBg:#111722;

  --okBg:#102016;
  --okBorder:#2f8a4c;

  --warnBg:#2a200f;
  --warnBorder:#b98a2d;

  --badBg:#2a1414;
  --badBorder:#b35a5a;

  --modalBackdrop:rgba(0,0,0,0.7);
  --modalBg:#141821;
  --modalText:#e9eef5;
  --shadow: 0 12px 30px rgba(0,0,0,0.35);
}

html,body{
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}

.wrap{
  height:100vh;
  display:grid;
  grid-template-rows:auto 1fr;
  gap:8px;
  padding:10px;
  box-sizing:border-box;
}

/* ===== HEADER (grid ‚Äî removes the ‚Äúgap‚Äù problem) ===== */
.headerGrid{
  display:grid;
  grid-template-columns: auto 1fr auto; /* left: title/controls, center: changes, right: theme */
  grid-template-rows: auto auto;        /* row1: h1, row2: controls */
  column-gap:12px;
  row-gap:2px;                          /* tight */
  align-items:start;
}

.headerGrid h1{
  grid-column:1;
  grid-row:1;
  margin:0;
  font-size:1.35rem;
  line-height:1.15;
  white-space:nowrap;
}

.controls{
  grid-column:1;
  grid-row:2;
  display:flex;
  align-items:center;
  gap:12px;
  font-size:.95em;
  color:var(--muted);
  flex-wrap:wrap;
  white-space:nowrap;
  margin:0;
  padding:0;
}

button{
  padding:6px 12px;
  border-radius:6px;
  border:1px solid var(--border);
  background:var(--btnBg);
  color:var(--text);
  cursor:pointer;
}
button:hover{background:var(--btnBgHover);}
button:disabled{opacity:.6;cursor:not-allowed;}

#themeToggle{
  grid-column:3;
  grid-row:1;
  justify-self:end;
}

/* Recent changes (center column) */
.changesBox{
  grid-column:2;
  grid-row:1 / span 2;    /* spans both rows so it stays centered vertically vs title+controls */
  align-self:start;
  justify-self:center;

  width: min(820px, 100%);
  max-width: 820px;
  min-width: 320px;

  border:1px solid var(--changesBorder);
  background: var(--changesBg);
  border-radius:10px;
  padding:8px 10px;
}

.changesHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:6px;
}

.changesTitle{
  font-weight:700;
  color: var(--changesTitle);
  font-size: 0.95rem;
  letter-spacing: 0.2px;
}

.changesExpandBtn{
  padding:4px 10px;
  font-size: 0.9rem;
  border-radius: 999px;
}

.changesTicker{
  position:relative;
  height: 40px;
  overflow:hidden;
  border:1px solid var(--borderSoft);
  border-radius:8px;
  background: var(--pillBg);
  padding:6px 10px;
}

.changesTrack{
  display:flex;
  flex-direction:column;
  gap:6px;
  will-change: transform;
}

.changesItem{
  display:flex;
  gap:8px;
  align-items:flex-start;
  font-size:0.92rem;
  line-height:1.1rem;
  color: var(--text);
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}

.tag{
  flex: 0 0 auto;
  font-size: 0.78rem;
  padding: 1px 8px;
  border-radius: 999px;
  border: 1px solid var(--borderSoft);
  background: transparent;
  color: var(--muted);
  line-height: 1.1rem;
}
.tag.ok{ background: rgba(0,0,0,0.05); border-color: var(--borderSoft); color: var(--text); }
:root[data-theme="dark"] .tag.ok{ background: rgba(255,255,255,0.06); }

.tag.warn{ background: var(--warnBg); border-color: var(--warnBorder); color: var(--text); }
.tag.bad{ background: var(--badBg); border-color: var(--badBorder); color: var(--text); }

.scrolling{ animation: tickerUp linear infinite; }
.changesTicker:hover .scrolling{ animation-play-state: paused; }

@keyframes tickerUp{
  from { transform: translateY(0); }
  to   { transform: translateY(var(--tickerEnd)); }
}

/* Modal */
.modalBackdrop{
  position:fixed;
  inset:0;
  background: var(--modalBackdrop);
  z-index: 1000;
}
.modal{
  position:fixed;
  inset:0;
  z-index: 1001;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 18px;
}
.modalCard{
  width: min(900px, 96vw);
  max-height: min(78vh, 700px);
  background: var(--modalBg);
  color: var(--modalText);
  border-radius: 14px;
  border: 1px solid var(--borderSoft);
  box-shadow: var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.modalHeader{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  padding: 12px 14px;
  border-bottom:1px solid var(--borderSoft);
  background: var(--tableHeadBg);
}
.modalTitle{ font-weight: 800; font-size: 1.05rem; }
.modalSub{ color: var(--muted); font-size: 0.95rem; margin-top:2px; }
.modalCloseBtn{ border-radius: 10px; padding: 6px 10px; }
.modalBody{ padding: 12px 14px; overflow:auto; }
.changesList{
  margin:0;
  padding-left: 18px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.footNote{
  color: var(--muted);
  font-size: 0.9rem;
  margin-top: 10px;
}
#changesModal[hidden],
#changesModalBackdrop[hidden]{
  display:none !important;
}

/* ===== MAIN GRID ===== */
.grid{
  display:grid;
  grid-template-rows:auto 1fr;
  gap:10px;
  min-height:0;
}

.panel{
  border:1px solid var(--border);
  border-radius:10px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height:0;
}

.hdr{
  padding:8px 10px;
  background:var(--tableHeadBg);
  border-bottom:1px solid var(--border);
  font-weight:700;
}

.body{
  padding:8px 10px;
  min-height:0;
}

/* MAP + RADAR */
.visuals{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  align-items:start;
}

#wwaMap{
  width:100%;
  height:auto;
  border:1px solid var(--borderSoft);
  visibility:hidden;
  display:block;

  /* responsive sizing for tablets/phones (no layout changes) */
  max-height: clamp(320px, 55vh, 720px);
  object-fit: contain;
}

.map-fallback{
  display:none;
  width:100%;
  min-height:240px;
  border:2px dashed var(--mapFallbackBorder);
  background:var(--mapFallbackBg);
  border-radius:10px;
  padding:18px;
  box-sizing:border-box;
  text-align:center;
  align-items:center;
  justify-content:center;
}
.map-fallback .title{font-weight:700;margin-bottom:6px;}
.map-fallback .text{color:var(--muted);line-height:1.35;max-width:70ch;margin:0 auto;}

.radarFrame{
  width:100%;
  border:1px solid var(--borderSoft);
  overflow:hidden;
  background:transparent;
}
.radarFrame iframe{
  width:100%;
  height:100%;
  border:0;
  display:block;
  pointer-events:none;
}

/* TABLE */
table{border-collapse:collapse;width:100%;}
th,td{padding:6px;border:1px solid var(--border);vertical-align:top;}
th{background:var(--tableHeadBg);text-align:left;}
td{word-break:break-word;}

.type-cell{font-weight:600;}
.type-warning{background:var(--warningBg);}
.type-watch{background:var(--watchBg);}
.type-adv{background:var(--advBg);}

/* AUTO SCROLL */
.auto-scroll{overflow:hidden;position:relative;}
.auto-scroll-inner{will-change:transform;}
.auto-scroll:hover .auto-scroll-inner{animation-play-state:paused;}

@keyframes summaryScroll{
  0%{transform:translateY(0);}
  80%{transform:translateY(calc(-1 * var(--scroll-distance)));}
  100%{transform:translateY(0);}
}

/* Responsive: stack header pieces cleanly */
@media (max-width: 1100px){
  .headerGrid{
    grid-template-columns: 1fr auto;
    grid-template-rows: auto auto auto;
  }
  .headerGrid h1{ grid-column:1 / -1; grid-row:1; white-space:normal; }
  .controls{ grid-column:1 / -1; grid-row:2; }
  .changesBox{ grid-column:1 / -1; grid-row:3; width:100%; min-width: 0; justify-self:stretch; }
  #themeToggle{ grid-column:2; grid-row:1; align-self:start; }
}

/* Optional: on narrower screens, stack map/radar */
@media (max-width: 900px){
  .visuals{ grid-template-columns:1fr; }
}
</style>
</head>

<body>
<!-- Force refresh on open (cache-bust once per tab session) -->
<script>
(() => {
  const KEY = "paalerts_refreshed_once";
  const pageKey = `${KEY}:${location.pathname}`;
  const nav = performance.getEntriesByType?.("navigation")?.[0];
  const wasBFCache = nav?.type === "back_forward";

  if (!sessionStorage.getItem(pageKey) || wasBFCache) {
    sessionStorage.setItem(pageKey, "1");
    const url = new URL(location.href);
    url.searchParams.set("_ts", Date.now().toString());
    location.replace(url.toString());
  }
})();
</script>

<div class="wrap">

  <!-- HEADER -->
  <div class="headerGrid">
    <h1>Pennsylvania Weather Hazard Overview</h1>

    <div class="controls">
      <span>Auto-refresh: 5 min</span>
      <button id="refreshBtn" type="button">Refresh</button>
      <span id="status">Loading‚Ä¶</span>
    </div>

    <div class="changesBox" aria-label="Recent changes">
      <div class="changesHeader">
        <span class="changesTitle">Recent changes</span>
        <button id="changesExpandBtn" class="changesExpandBtn" type="button" aria-haspopup="dialog" aria-controls="changesModal">
          Expand
        </button>
      </div>
      <div class="changesTicker" role="status" aria-live="polite" aria-atomic="true">
        <div class="changesTrack" id="changesTrack"></div>
      </div>
    </div>

    <button id="themeToggle" type="button">üåô Dark</button>
  </div>

  <!-- MAIN -->
  <div class="grid">
    <div class="panel">
      <div class="hdr">PA Alert Map & Radar</div>
      <div class="body">
        <div class="visuals">
          <div>
            <img id="wwaMap"
              src="https://www.weather.gov/images/crh/noc/wwa_pa.png"
              alt="NWS Watches, Warnings, and Advisories map for Pennsylvania"
              onload="mapLoaded()"
              onerror="mapError()"
            />
            <div id="wwaMapFallback" class="map-fallback" role="status" aria-live="polite">
              <div>
                <div class="title">NWS Alert Map Unavailable</div>
                <div class="text">The NWS Watches, Warnings, and Advisories map is currently unavailable.</div>
              </div>
            </div>
          </div>

          <div class="radarFrame" id="radarFrame" aria-label="Locked radar">
            <iframe
              id="radarIframe"
              title="Radar (locked)"
              src="https://embed.windy.com/embed2.html?lat=40.9&lon=-77.9&detailLat=40.9&detailLon=-77.9&level=surface&overlay=radar&product=radar&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=mph&metricTemp=%C2%B0F&radarRange=-1&play=1"
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
              allowfullscreen>
            </iframe>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="hdr">Alert Summary</div>
      <div class="body auto-scroll">
        <div id="tableContainer" class="auto-scroll-inner"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modalBackdrop" id="changesModalBackdrop" hidden></div>
<div class="modal" id="changesModal" role="dialog" aria-modal="true" aria-labelledby="changesModalTitle" hidden>
  <div class="modalCard">
    <div class="modalHeader">
      <div>
        <div id="changesModalTitle" class="modalTitle">Recent changes</div>
        <div class="modalSub" id="changesModalSub">Since open</div>
      </div>
      <button class="modalCloseBtn" id="changesCloseBtn" type="button" aria-label="Close">‚úï</button>
    </div>
    <div class="modalBody">
      <ul class="changesList" id="changesModalList"></ul>
      <div class="footNote" id="changesFootNote"></div>
    </div>
  </div>
</div>

<script>
/* ==============================
   THEME
   ============================== */
(() => {
  const root = document.documentElement;
  const btn = document.getElementById("themeToggle");
  const key = "pa_alerts_theme";
  const saved = localStorage.getItem(key) || "system";

  function apply(t){
    if(t === "system"){
      root.dataset.theme = matchMedia("(prefers-color-scheme:dark)").matches ? "dark" : "light";
    } else {
      root.dataset.theme = t;
    }
    btn.textContent = root.dataset.theme === "dark" ? "‚òÄÔ∏è Light" : "üåô Dark";
  }

  apply(saved);

  if (saved === "system" && window.matchMedia) {
    const mq = window.matchMedia("(prefers-color-scheme: dark)");
    const handler = () => apply("system");
    if (mq.addEventListener) mq.addEventListener("change", handler);
    else if (mq.addListener) mq.addListener(handler);
  }

  btn.addEventListener("click", () => {
    const next = root.dataset.theme === "dark" ? "light" : "dark";
    localStorage.setItem(key, next);
    apply(next);
  });
})();

/* ==============================
   MAP/RADAR SYNC
   ============================== */
function syncRadarToMap(){
  const map = document.getElementById("wwaMap");
  const radar = document.getElementById("radarFrame");
  if(!map || !radar) return;
  const h = Math.round(map.getBoundingClientRect().height);
  if(h > 100) radar.style.height = h + "px";
}

function mapLoaded(){
  const map = document.getElementById("wwaMap");
  const fb = document.getElementById("wwaMapFallback");
  if(fb) fb.style.display = "none";
  map.style.display = "block";
  map.style.visibility = "visible";
  requestAnimationFrame(syncRadarToMap);
}

function mapError(){
  const map = document.getElementById("wwaMap");
  const fb = document.getElementById("wwaMapFallback");
  const radar = document.getElementById("radarFrame");
  if(map){
    map.style.display = "none";
    map.style.visibility = "hidden";
  }
  if(fb) fb.style.display = "flex";
  if(radar) radar.style.height = "520px";
}

window.addEventListener("resize", () => {
  clearTimeout(window.__syncTimer);
  window.__syncTimer = setTimeout(syncRadarToMap, 150);
});

/* ==============================
   AUTO-SCROLL (only when overflow)
   ============================== */
function setupAutoScroll(){
  const outer = document.querySelector(".auto-scroll");
  const inner = document.querySelector(".auto-scroll-inner");
  if(!outer || !inner) return;

  inner.style.animation = "none";
  const overflow = inner.scrollHeight - outer.clientHeight;
  if(overflow <= 0) return;

  inner.style.setProperty("--scroll-distance", overflow + "px");
  const duration = Math.max(20, overflow / 18);
  inner.style.animation = `summaryScroll ${duration}s linear infinite`;
}

/* ==============================
   ALERT FETCH
   ============================== */
const API_URL = "https://api.weather.gov/alerts/active?area=PA";
const MAP_URL = "https://www.weather.gov/images/crh/noc/wwa_pa.png";
const zoneCache = new Map();

function typePriority(evt){
  const s = (evt || "").toLowerCase();
  if (s.includes("warning") || s.includes("emergency")) return 0;
  if (s.includes("watch")) return 1;
  return 2;
}
function typeClass(evt){
  const s = (evt || "").toLowerCase();
  if (s.includes("warning") || s.includes("emergency")) return "type-warning";
  if (s.includes("watch")) return "type-watch";
  return "type-adv";
}

function fmtTime(v){
  if(!v) return "N/A";
  const d = new Date(v);
  return isNaN(d) ? String(v) : d.toLocaleString([],{
    month:"2-digit", day:"2-digit", year:"2-digit",
    hour:"2-digit", minute:"2-digit"
  });
}
function toTimeMs(v){
  const t = new Date(v || 0).getTime();
  return isNaN(t) ? Number.MAX_SAFE_INTEGER : t;
}

function normalizeSummaryCounty(name){
  let s = String(name || "").trim();
  s = s.replace(/^(Higher\s+Elevations\s+of|Elevations\s+of)\s+/i, "");
  s = s.replace(/^(Upper|Lower|North|South|East|West|NE|NW|SE|SW|Northeast|Northwest|Southeast|Southwest|Northern|Southern|Eastern|Western)\b\.?\s+/i, "");
  s = s.replace(/\s+(Ridges?|Ridge|Higher\s+Elevations?)$/i, "");
  return s.trim();
}

function locationSortKey(name){
  return String(name || "")
    .trim()
    .replace(/^(n|s|e|w|ne|nw|se|sw|north|south|east|west|upper|lower|higher elevations?|northern|southern|eastern|western|northeastern|northwestern|southeastern|southwestern)\b\.?\s+/i, "")
    .trim()
    .toLowerCase();
}
function sortLocations(arr){
  return [...arr].sort((a,b)=>{
    const ka = locationSortKey(a);
    const kb = locationSortKey(b);
    return ka === kb ? String(a).localeCompare(String(b)) : ka.localeCompare(kb);
  });
}

function fetchWithTimeout(url, options={}, timeoutMs=12000){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);
  return fetch(url, {...options, signal: controller.signal}).finally(() => clearTimeout(t));
}

function isWantedAlert(p){
  const e = (p.event || "").toLowerCase();
  return (
    (e.includes("watch") || e.includes("warning") || e.includes("advisory") || e.includes("emergency")) &&
    !e.includes("statement") &&
    !e.includes("outlook") &&
    !e.includes("test")
  );
}
function isMarineZone(url){
  return typeof url === "string" && url.includes("/zones/marine/");
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function zoneName(url){
  if(zoneCache.has(url)) return zoneCache.get(url);
  try{
    const r = await fetchWithTimeout(url, {headers:{Accept:"application/geo+json"}}, 10000);
    if(!r.ok) throw new Error("HTTP "+r.status);
    const j = await r.json();
    const name = (j.properties?.state === "PA") ? (j.properties?.name || null) : null;
    zoneCache.set(url, name);
    return name;
  }catch{
    zoneCache.set(url, null);
    return null;
  }
}

function refreshMap(){
  const img = document.getElementById("wwaMap");
  const fb = document.getElementById("wwaMapFallback");
  if (fb) fb.style.display = "none";
  if (img){
    img.style.display = "block";
    img.style.visibility = "hidden";
    img.src = MAP_URL + "?t=" + Date.now();
  }
}

/* ==============================
   Recent Changes (adds/drops/time)
   Baseline on first successful fetch (so it starts empty per open)
   "No changes since open" then "No changes since refresh"
   ============================== */
const RecentChanges = (() => {
  const MAX_TICKER_ITEMS = 6;
  const MAX_HISTORY_LINES = 80;

  const track = document.getElementById("changesTrack");
  const expandBtn = document.getElementById("changesExpandBtn");
  const modalBackdrop = document.getElementById("changesModalBackdrop");
  const modal = document.getElementById("changesModal");
  const modalList = document.getElementById("changesModalList");
  const modalSub = document.getElementById("changesModalSub");
  const modalClose = document.getElementById("changesCloseBtn");
  const foot = document.getElementById("changesFootNote");

  const sessionStart = new Date();
  const sessionStartStr = sessionStart.toLocaleString([],{
    month:"2-digit", day:"2-digit", year:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  });

  let last = {};
  let history = [];
  let lastHadChanges = false;

  let hasBaselined = false;
  let hasRefreshedOnce = false;

  function clsFor(k){
    return (k === "OK") ? "ok" :
      (k === "NEW" || k === "TIME" || k === "+") ? "warn" :
      (k === "CLR" || k === "-" || k === "ERR") ? "bad" : "";
  }

  function renderTicker(lines){
    track.classList.remove("scrolling");
    track.style.removeProperty("--tickerEnd");
    track.innerHTML = "";

    const use = (lines || []).slice(0, MAX_TICKER_ITEMS);

    if (!use.length){
      const div = document.createElement("div");
      div.className = "changesItem";

      const msg = hasRefreshedOnce
        ? "No changes since refresh"
        : "No changes since open";

      div.innerHTML = `<span class="tag ok">OK</span><span>${msg}</span>`;
      track.appendChild(div);
      return;
    }

    for (const ln of use){
      const div = document.createElement("div");
      div.className = "changesItem";
      div.title = ln.text;
      div.innerHTML = `<span class="tag ${clsFor(ln.kind)}">${ln.kind}</span><span>${escapeHtml(ln.text)}</span>`;
      track.appendChild(div);
    }

    if (use.length > 1){
      for (const ln of use){
        const div = document.createElement("div");
        div.className = "changesItem";
        div.title = ln.text;
        div.innerHTML = `<span class="tag ${clsFor(ln.kind)}">${ln.kind}</span><span>${escapeHtml(ln.text)}</span>`;
        track.appendChild(div);
      }

      requestAnimationFrame(() => {
        const half = Math.floor(track.scrollHeight / 2);
        track.style.setProperty("--tickerEnd", `-${half}px`);
        const seconds = Math.max(10, use.length * 2.5);
        track.style.animationDuration = `${seconds}s`;
        track.classList.add("scrolling");
      });
    }
  }

  function renderModal(){
    modalList.innerHTML = "";
    if (!history.length){
      const li = document.createElement("li");
      li.textContent = "No changes logged yet (this session).";
      modalList.appendChild(li);
    } else {
      for (const line of history){
        const li = document.createElement("li");
        li.textContent = line;
        modalList.appendChild(li);
      }
    }
    foot.textContent = lastHadChanges
      ? "Tip: Hover the ticker to pause the scroll."
      : "No changes detected on the most recent refresh.";
  }

  function openModal(){
    modalBackdrop.hidden = false;
    modal.hidden = false;
    modalClose.focus();
    document.addEventListener("keydown", onKey, { passive:true });
  }
  function closeModal(){
    modalBackdrop.hidden = true;
    modal.hidden = true;
    document.removeEventListener("keydown", onKey);
  }
  function onKey(e){ if(e.key === "Escape") closeModal(); }

  expandBtn.addEventListener("click", () => { renderModal(); openModal(); });
  modalClose.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", closeModal);

  function diff(prev, cur){
    const changes = [];

    const curEventLoc = new Map();
    const prevEventLoc = new Map();
    for (const [id, v] of Object.entries(cur)) curEventLoc.set(`${v.event}||${v.locSig}`, id);
    for (const [id, v] of Object.entries(prev)) prevEventLoc.set(`${v.event}||${v.locSig}`, id);

    const matchedPrev = new Set();
    const matchedCur = new Set();

    // TIME: same event+same locations; expires changed
    for (const [key, cid] of curEventLoc.entries()){
      const pid = prevEventLoc.get(key);
      if (!pid) continue;
      matchedPrev.add(pid);
      matchedCur.add(cid);
      const pv = prev[pid], cv = cur[cid];
      if ((pv.expiresStr || "") !== (cv.expiresStr || "")){
        changes.push({ kind:"TIME", text:`${cv.event} ‚Äì expires ${pv.expiresStr} ‚Üí ${cv.expiresStr}` });
      }
    }

    // +/-: same exact group (event||expires)
    for (const [cid, cv] of Object.entries(cur)){
      if (matchedCur.has(cid)) continue;
      const pv = prev[cid];
      if (!pv) continue;

      const added = [];
      const removed = [];
      for (const x of cv.locSet) if (!pv.locSet.has(x)) added.push(x);
      for (const x of pv.locSet) if (!cv.locSet.has(x)) removed.push(x);

      const show = (arr) => arr.slice(0,4).join("; ") + (arr.length>4 ? ` (+${arr.length-4} more)` : "");
      if (added.length) changes.push({ kind:"+", text:`${cv.event} ‚Äì added ${added.length}: ${show(added)}` });
      if (removed.length) changes.push({ kind:"-", text:`${cv.event} ‚Äì removed ${removed.length}: ${show(removed)}` });

      matchedPrev.add(cid);
      matchedCur.add(cid);
    }

    // NEW
    for (const [cid, cv] of Object.entries(cur)){
      if (prev[cid] || matchedCur.has(cid)) continue;
      changes.push({ kind:"NEW", text:`${cv.event} ‚Äì ${cv.locSig || "Locations updated"}` });
    }

    // CLR
    for (const [pid, pv] of Object.entries(prev)){
      if (cur[pid] || matchedPrev.has(pid)) continue;
      changes.push({ kind:"CLR", text:`${pv.event} ‚Äì cleared` });
    }

    return changes;
  }

  function update(groups, nowStr){
    const cur = {};
    for (const g of (groups || [])){
      const id = `${g.event}||${g.expires || ""}`;
      const locArr = g.locationsArr || [];
      cur[id] = {
        event: g.event,
        expires: g.expires || "",
        expiresStr: g.expiresStr || "N/A",
        locSet: new Set(locArr),
        locSig: locArr.join(";")
      };
    }

    // baseline first successful update (starts empty per open)
    if (!hasBaselined){
      hasBaselined = true;
      last = cur;
      history = [];
      lastHadChanges = false;

      // mark that we've completed at least one refresh cycle
      hasRefreshedOnce = true;

      renderTicker([]); // shows "since open" first, then will say "since refresh" afterward
      renderModal();
      modalSub.textContent = `Since open (${sessionStartStr})`;
      return;
    }

    const changes = diff(last, cur);
    lastHadChanges = changes.length > 0;
    last = cur;

    if (changes.length){
      const lines = changes.map(c => `[${nowStr}] ${c.kind}: ${c.text}`);
      history = [...lines, ...history].slice(0, MAX_HISTORY_LINES);
    }

    renderTicker(changes);
    renderModal();
    modalSub.textContent = `Since open (${sessionStartStr})`;
  }

  renderTicker([]);
  modalSub.textContent = `Since open (${sessionStartStr})`;
  return { update };
})();

/* ==============================
   fetchAlerts
   ============================== */
async function fetchAlerts(){
  const status = document.getElementById("status");
  const btn = document.getElementById("refreshBtn");
  const container = document.getElementById("tableContainer");

  btn.disabled = true;
  status.textContent = "Loading‚Ä¶";

  try{
    const r = await fetchWithTimeout(
      API_URL,
      {headers:{Accept:"application/geo+json"}, cache:"no-store"},
      12000
    );
    if(!r.ok) throw new Error("HTTP "+r.status);
    const d = await r.json();

    const grouped = new Map();

    for(const f of (d.features || [])){
      const p = f?.properties;
      if(!p || !isWantedAlert(p)) continue;

      const zones = (p.affectedZones || []).filter(z => !isMarineZone(z));
      if(!zones.length) continue;

      const zoneInfos = await Promise.all(zones.map(z => zoneName(z)));
      const namesRaw = zoneInfos.filter(Boolean);
      if(!namesRaw.length) continue;

      const names = namesRaw.map(normalizeSummaryCounty);
      const expires = p.ends || p.expires || "";

      const key = `${p.event}||${expires}`;
      if(!grouped.has(key)){
        grouped.set(key, {event: p.event, expires: expires, names: new Set()});
      }
      names.forEach(n => grouped.get(key).names.add(n));
    }

    let arr = [...grouped.values()];

    const nowStr = new Date().toLocaleString([],{
      month:"2-digit", day:"2-digit", year:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    });

    if(!arr.length){
      container.innerHTML = `<div style="color:var(--muted)">No active watches, warnings, or advisories.</div>`;
      status.textContent = `Last updated: ${nowStr} | Alert Groups: 0`;
      RecentChanges.update([], nowStr);
      setupAutoScroll();
      requestAnimationFrame(syncRadarToMap);
      return;
    }

    arr.sort((a,b)=>{
      const tp = typePriority(a.event) - typePriority(b.event);
      if(tp !== 0) return tp;
      const te = toTimeMs(a.expires) - toTimeMs(b.expires);
      if(te !== 0) return te;
      return String(a.event).localeCompare(String(b.event));
    });

    status.textContent = `Last updated: ${nowStr} | Alert Groups: ${arr.length}`;

    const changeGroups = arr.map(g => {
      const namesSorted = sortLocations([...g.names]);
      return {
        event: g.event,
        expires: g.expires || "",
        expiresStr: g.expires ? fmtTime(g.expires) : "N/A",
        locationsArr: namesSorted
      };
    });

    RecentChanges.update(changeGroups, nowStr);

    container.innerHTML = `
      <table>
        <colgroup>
          <col style="width:22%;">
          <col style="width:63%;">
          <col style="width:15%;">
        </colgroup>
        <tr><th>Type</th><th>Locations</th><th>Expires</th></tr>
        ${arr.map(g=>{
          const namesSorted = sortLocations([...g.names]);
          return `
            <tr>
              <td class="type-cell ${typeClass(g.event)}">${escapeHtml(g.event)}</td>
              <td>${namesSorted.map(escapeHtml).join("; ")}</td>
              <td>${escapeHtml(fmtTime(g.expires))}</td>
            </tr>
          `;
        }).join("")}
      </table>
    `;

    requestAnimationFrame(() => {
      setupAutoScroll();
      syncRadarToMap();
    });

  }catch(err){
    console.error(err);
    container.innerHTML = `<div style="color:var(--muted)">Unable to load alerts.</div>`;
    status.textContent = "Error: " + (err?.message || String(err));

    const track = document.getElementById("changesTrack");
    if (track) {
      track.classList.remove("scrolling");
      track.style.removeProperty("--tickerEnd");
      track.innerHTML = `<div class="changesItem"><span class="tag bad">ERR</span><span>Unable to load alerts (see status)</span></div>`;
    }

    setupAutoScroll();
  }finally{
    btn.disabled = false;
  }
}

function refreshAll(){
  refreshMap();
  fetchAlerts();
}

document.getElementById("refreshBtn").addEventListener("click", refreshAll);

/* Phone radar: zoom out to show all of PA */
function setRadarZoom(){
  const iframe = document.getElementById("radarIframe");
  if(!iframe) return;

  const isPhone = window.matchMedia("(max-width: 600px)").matches;
  const zoom = isPhone ? 5 : 7;

  const url = new URL(iframe.src);
  url.searchParams.set("zoom", String(zoom));

  if (iframe.src !== url.toString()) iframe.src = url.toString();
}

setRadarZoom();
window.addEventListener("resize", () => {
  clearTimeout(window.__radarZoomTimer);
  window.__radarZoomTimer = setTimeout(setRadarZoom, 200);
});

refreshAll();
setInterval(refreshAll, 5 * 60 * 1000);

if (location.search.includes("_ts=")) {
  history.replaceState(null, "", location.pathname);
}
</script>
</body>
</html>
