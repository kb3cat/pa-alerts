<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PA Alerts Dashboard</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      color-scheme: light;

      --bg:#ffffff;
      --text:#111111;
      --muted:#555555;

      --border:#333333;
      --borderSoft:#cccccc;

      --panel:#f6f6f6;
      --panel2:#f0f0f0;

      --btnBg:#ffffff;
      --btnBgHover:#f3f3f3;
      --btnBorder:#333333;

      --pillBg:#ffffff;

      --good:#1f7a1f;
      --warn:#a40000;
      --watch:#b06a00;
      --adv:#1c4aa5;

      --shadow: 0 1px 0 rgba(0,0,0,0.04);
    }

    body.dark{
      color-scheme: dark;

      --bg:#0f1115;
      --text:#e9e9e9;
      --muted:#b7b7b7;

      --border:#d0d0d0;
      --borderSoft:#2a2f3a;

      --panel:#141823;
      --panel2:#0f141d;

      --btnBg:#141823;
      --btnBgHover:#1a2130;
      --btnBorder:#d0d0d0;

      --pillBg:#141823;

      --shadow: 0 1px 0 rgba(255,255,255,0.04);
    }

    *{ box-sizing: border-box; }
    body{
      margin: 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      max-width: 1400px;
      margin: 0 auto 10px auto;
    }

    .titleBlock{
      min-width: 260px;
      flex: 1 1 320px;
    }

    h1{
      margin: 0 0 2px 0;
      font-size: 1.55rem;
      letter-spacing: 0.2px;
      line-height: 1.2;
    }

    .refreshRow{
      margin: 0;
      padding: 0;
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .refreshRow .k{
      color: var(--muted);
    }

    .refreshRow .v{
      color: var(--text);
      font-weight: 600;
    }

    .btn{
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--btnBorder);
      background: var(--btnBg);
      color: var(--text);
      cursor: pointer;
      font: inherit;
      box-shadow: var(--shadow);
      user-select: none;
    }
    .btn:hover{ background: var(--btnBgHover); }

    /* Recent changes box centered between title and theme (your layout request) */
    .changesBox{
      flex: 0 1 420px;
      min-width: 280px;
      border: 1px solid var(--borderSoft);
      background: var(--panel);
      border-radius: 12px;
      padding: 10px 10px 8px 10px;
      box-shadow: var(--shadow);
      align-self: stretch;
    }
    .changesHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .changesHeader .title{
      font-weight: 700;
      letter-spacing: .2px;
    }
    .changesHeader .meta{
      color: var(--muted);
      font-size: 0.9rem;
      white-space: nowrap;
    }
    .changesList{
      max-height: 150px;
      overflow:auto;
      padding-right: 6px;
    }
    .changeItem{
      padding: 6px 8px;
      border: 1px solid var(--borderSoft);
      background: var(--pillBg);
      border-radius: 10px;
      margin-bottom: 6px;
      font-size: 0.92rem;
      line-height: 1.25;
    }
    .changeItem:last-child{ margin-bottom: 0; }

    .chgLine{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }
    .chgText{ flex: 1 1 auto; }
    .chgTime{
      color: var(--muted);
      font-size: 0.85rem;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .tag{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--borderSoft);
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.2px;
      margin-right: 6px;
      vertical-align: baseline;
    }
    .tag.add{ border-color: rgba(31,122,31,0.6); }
    .tag.drop{ border-color: rgba(164,0,0,0.55); }
    .tag.change{ border-color: rgba(176,106,0,0.6); }

    .rightControls{
      flex: 0 0 auto;
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:flex-end;
      min-width: 160px;
    }

    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 12px;
    }

    @media (max-width: 980px){
      .wrap{
        grid-template-columns: 1fr;
      }
      .changesBox{
        order: 2;
      }
    }

    /* Map auto-size: responsive to viewport (fix for iPad tightness) */
    #alertMap{
      width: 100%;
      height: clamp(300px, 55vh, 700px);
      border-radius: 12px;
      border: 1px solid var(--borderSoft);
      overflow:hidden;
      box-shadow: var(--shadow);
    }

    .panel{
      border: 1px solid var(--borderSoft);
      border-radius: 12px;
      background: var(--panel);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding: 10px 12px;
      background: var(--panel2);
      border-bottom: 1px solid var(--borderSoft);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .panelHeader .title{
      font-weight: 800;
      letter-spacing: .2px;
    }
    .panelHeader .meta{
      color: var(--muted);
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .tableWrap{
      max-height: 55vh;
      overflow:auto; /* auto-scroll alert summary if it runs out of room */
    }

    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--panel2);
      border-bottom: 1px solid var(--borderSoft);
      text-align:left;
      padding: 10px 10px;
      font-weight: 800;
    }
    tbody td{
      border-bottom: 1px solid var(--borderSoft);
      padding: 10px 10px;
      vertical-align: top;
    }
    tbody tr:hover td{
      background: rgba(127,127,127,0.08);
    }

    .pill{
      display:inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid var(--borderSoft);
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 0.84rem;
      background: var(--pillBg);
      white-space: nowrap;
    }
    .pill.warning{ border-color: rgba(164,0,0,0.55); }
    .pill.watch{ border-color: rgba(176,106,0,0.6); }
    .pill.advisory{ border-color: rgba(28,74,165,0.6); }
    .pill.other{ border-color: rgba(120,120,120,0.6); }

    .smallMuted{ color: var(--muted); font-size: 0.9rem; }

    .foot{
      max-width: 1400px;
      margin: 10px auto 0 auto;
      color: var(--muted);
      font-size: 0.9rem;
      display:flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Leaflet attribution looks better in dark mode if we soften it */
    body.dark .leaflet-control-attribution{
      background: rgba(20,24,35,0.8);
      color: var(--muted);
      border-color: var(--borderSoft);
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="titleBlock">
      <h1>PA Watches, Warnings & Advisories</h1>
      <div class="refreshRow" aria-label="Refresh status">
        <span class="k">Auto refresh:</span> <span class="v" id="autoRefreshLabel">60s</span>
        <span class="k">Last updated:</span> <span class="v" id="lastUpdated">—</span>
        <span class="k">Alert Groups:</span> <span class="v" id="groupCount">—</span>
        <button class="btn" id="refreshBtn" title="Refresh now">Refresh</button>
      </div>
    </div>

    <div class="changesBox" aria-label="Recent changes">
      <div class="changesHeader">
        <div class="title">Recent Changes</div>
        <div class="meta" id="changesMeta">Since open</div>
      </div>
      <div class="changesList" id="changesList">
        <div class="smallMuted" id="changesEmpty">No changes yet.</div>
      </div>
    </div>

    <div class="rightControls">
      <button class="btn" id="themeBtn" title="Toggle light/dark">Light/Dark</button>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="panelHeader">
        <div class="title">Alert Map</div>
        <div class="meta smallMuted">Auto-fit PA • responsive sizing</div>
      </div>
      <div id="alertMap" role="img" aria-label="Pennsylvania alert map"></div>
    </div>

    <div class="panel">
      <div class="panelHeader">
        <div class="title">Alert Summary</div>
        <div class="meta" id="alertMeta">0 alerts</div>
      </div>

      <div class="tableWrap">
        <table aria-label="Alert summary table">
          <thead>
            <tr>
              <th style="width: 140px;">Type</th>
              <th>Event / Area</th>
              <th style="width: 170px;">Expires</th>
            </tr>
          </thead>
          <tbody id="alertBody">
            <tr><td colspan="3" class="smallMuted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="foot">
    <div>Data source: NWS API</div>
    <div id="totalLine">0 of 0</div>
  </div>

<script>
/* =========================
   Settings
========================= */
const AUTO_REFRESH_MS = 60000; // 60s
document.getElementById("autoRefreshLabel").textContent = (AUTO_REFRESH_MS/1000) + "s";

const PA_BOUNDS = [
  [39.7, -80.6], // SW
  [42.5, -74.7]  // NE
];

const TYPE_ORDER = { "Warning": 0, "Watch": 1, "Advisory": 2, "Statement": 3, "Other": 9 };

/* =========================
   Theme
========================= */
const themeBtn = document.getElementById("themeBtn");
(function initTheme(){
  const saved = localStorage.getItem("paAlertsTheme");
  if(saved === "dark") document.body.classList.add("dark");
})();
themeBtn.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  localStorage.setItem("paAlertsTheme", document.body.classList.contains("dark") ? "dark" : "light");
});

/* =========================
   Recent Changes (since open)
   Baseline first successful fetch
========================= */
let previousAlertIndex = null;
let hasBaselined = false;

let recentChanges = []; // newest first
const changesListEl = document.getElementById("changesList");
const changesEmptyEl = document.getElementById("changesEmpty");
const changesMetaEl = document.getElementById("changesMeta");

const sessionStart = new Date();
changesMetaEl.textContent = "Since open (" + fmtClock(sessionStart) + ")";

// ensure empty on open
renderRecentChanges();

/* =========================
   Leaflet Map
========================= */
let map, geoLayer;

function initMap(){
  map = L.map("alertMap", {
    zoomControl: true,
    preferCanvas: true
  });

  // Tiles
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  // Layer placeholder
  geoLayer = L.geoJSON([], {
    style: featureStyle,
    onEachFeature: (feature, layer) => {
      layer.on("click", () => {
        const p = feature.properties || {};
        const html =
          `<div style="font-weight:800;margin-bottom:4px;">${escapeHtml(p.event || "Alert")}</div>
           <div style="font-size:0.9rem;color:varColorMuted()">
             <div><b>Type:</b> ${escapeHtml(p.severity || "—")}</div>
             <div><b>Expires:</b> ${escapeHtml(fmtTime(p.expires))}</div>
             <div style="margin-top:6px;"><b>Area:</b> ${escapeHtml(p.areaDesc || "—")}</div>
           </div>`;
        layer.bindPopup(html).openPopup();
      });
    }
  }).addTo(map);

  // Fit PA (responsive zoom)
  map.fitBounds(PA_BOUNDS, { padding: [20, 20] });

  // Refit on resize/orientation changes
  window.addEventListener("resize", () => {
    if(!map) return;
    map.invalidateSize();
    map.fitBounds(PA_BOUNDS, { padding: [20, 20] });
  });
}

function featureStyle(feature){
  const p = feature.properties || {};
  const sev = (p.severity || "").toLowerCase();
  // let leaflet pick default colors; only adjust opacity/border
  // (no explicit colors requested)
  return {
    weight: 2,
    opacity: 0.9,
    fillOpacity: sev.includes("severe") ? 0.35 : 0.25
  };
}

/* =========================
   Fetch + Render
========================= */
const alertBody = document.getElementById("alertBody");
const alertMeta = document.getElementById("alertMeta");
const lastUpdated = document.getElementById("lastUpdated");
const groupCount = document.getElementById("groupCount");
const totalLine = document.getElementById("totalLine");
const refreshBtn = document.getElementById("refreshBtn");

refreshBtn.addEventListener("click", () => refreshAlerts(true));

async function fetchAlertsPA(){
  // Cache-bust behind the scenes (doesn't touch the address bar)
  const url = "https://api.weather.gov/alerts/active?area=PA&_ts=" + Date.now();

  const res = await fetch(url, {
    cache: "no-store",
    headers: {
      "Accept": "application/geo+json"
    }
  });

  if(!res.ok){
    throw new Error("NWS API error: " + res.status);
  }
  const data = await res.json();
  const features = Array.isArray(data.features) ? data.features : [];
  return features;
}

function classifyType(eventName){
  const e = (eventName || "").toLowerCase();
  if(e.includes("warning")) return "Warning";
  if(e.includes("watch")) return "Watch";
  if(e.includes("advisory")) return "Advisory";
  if(e.includes("statement")) return "Statement";
  return "Other";
}

function pillClass(type){
  if(type === "Warning") return "warning";
  if(type === "Watch") return "watch";
  if(type === "Advisory") return "advisory";
  return "other";
}

function indexAlerts(alerts){
  const m = new Map();
  for(const a of alerts){
    const p = a.properties || {};
    // Prefer stable NWS id if present
    const id =
      a.id ||
      p.id ||
      (p.event + "|" + (p.sent||"") + "|" + (p.effective||"") + "|" + (p.expires||"") + "|" + (p.areaDesc||""));

    m.set(id, {
      id,
      event: p.event || "—",
      areaDesc: p.areaDesc || "—",
      expires: p.expires || null,
      sent: p.sent || null
    });
  }
  return m;
}

function diffAlerts(prev, curr){
  const out = [];
  const now = new Date();

  // Adds
  for(const [id, a] of curr){
    if(!prev.has(id)){
      out.push({
        type: "ADD",
        at: now,
        text: `${a.event} added`,
        detail: a.areaDesc
      });
    }
  }

  // Drops
  for(const [id, a] of prev){
    if(!curr.has(id)){
      out.push({
        type: "DROP",
        at: now,
        text: `${a.event} removed`,
        detail: a.areaDesc
      });
    }
  }

  // Changes (expiration time changes)
  for(const [id, aPrev] of prev){
    const aCurr = curr.get(id);
    if(!aCurr) continue;

    if((aPrev.expires || "") !== (aCurr.expires || "")){
      out.push({
        type: "CHANGE",
        at: now,
        text: `${aCurr.event} expiration changed`,
        detail: `${fmtTime(aPrev.expires)} → ${fmtTime(aCurr.expires)}`
      });
    }
  }

  // newest first
  out.sort((a,b) => b.at - a.at);
  return out;
}

function computeGroupCount(alerts){
  // Simple grouping: event name only (stable and useful).
  // Your page can have more advanced “combined zones” grouping elsewhere;
  // this count reflects grouped event types present.
  const s = new Set();
  for(const a of alerts){
    const p = a.properties || {};
    s.add(p.event || "—");
  }
  return s.size;
}

function renderTable(alerts){
  const rows = [];

  // Build view model
  const vm = alerts.map(a => {
    const p = a.properties || {};
    const type = classifyType(p.event);
    return {
      type,
      typeOrder: TYPE_ORDER[type] ?? 9,
      event: p.event || "—",
      area: p.areaDesc || "—",
      expires: p.expires || null,
      expiresMs: p.expires ? Date.parse(p.expires) : Number.POSITIVE_INFINITY
    };
  });

  // Sort: 1) Type order 2) expiration (soonest first)
  vm.sort((x,y) => (x.typeOrder - y.typeOrder) || (x.expiresMs - y.expiresMs));

  if(vm.length === 0){
    alertBody.innerHTML = `<tr><td colspan="3" class="smallMuted">No active alerts.</td></tr>`;
    return;
  }

  for(const a of vm){
    rows.push(`
      <tr>
        <td><span class="pill ${pillClass(a.type)}">${escapeHtml(a.type)}</span></td>
        <td>
          <div style="font-weight:800;">${escapeHtml(a.event)}</div>
          <div class="smallMuted">${escapeHtml(a.area)}</div>
        </td>
        <td>${escapeHtml(fmtTime(a.expires))}</td>
      </tr>
    `);
  }

  alertBody.innerHTML = rows.join("");
}

function renderMap(alerts){
  if(!geoLayer) return;

  // Build GeoJSON of alert polygons (some alerts may have null geometry)
  const geojson = {
    type: "FeatureCollection",
    features: alerts
      .filter(f => !!f.geometry)
      .map(f => {
        const p = f.properties || {};
        // clone only needed props for popup/style
        return {
          type: "Feature",
          geometry: f.geometry,
          properties: {
            event: p.event,
            severity: p.severity,
            expires: p.expires,
            areaDesc: p.areaDesc
          }
        };
      })
  };

  geoLayer.clearLayers();
  geoLayer.addData(geojson);

  // Keep map fitted to PA (not to alerts) so it always frames the state nicely
  map.fitBounds(PA_BOUNDS, { padding: [20, 20] });
}

function renderRecentChanges(){
  if(recentChanges.length === 0){
    changesListEl.innerHTML = `<div class="smallMuted" id="changesEmpty">No changes yet.</div>`;
    return;
  }

  const html = recentChanges.map(ch => {
    const tagClass = ch.type === "ADD" ? "add" : (ch.type === "DROP" ? "drop" : "change");
    const tagLabel = ch.type === "ADD" ? "ADD" : (ch.type === "DROP" ? "DROP" : "CHANGE");
    const detail = ch.detail ? `<div class="smallMuted" style="margin-top:2px;">${escapeHtml(ch.detail)}</div>` : "";
    return `
      <div class="changeItem">
        <div class="chgLine">
          <div class="chgText">
            <span class="tag ${tagClass}">${tagLabel}</span>
            ${escapeHtml(ch.text)}
            ${detail}
          </div>
          <div class="chgTime">${fmtClock(ch.at)}</div>
        </div>
      </div>
    `;
  }).join("");

  changesListEl.innerHTML = html;
}

function setMeta(alerts){
  const total = alerts.length;
  alertMeta.textContent = total + (total === 1 ? " alert" : " alerts");
  totalLine.textContent = total + " of " + total;
  groupCount.textContent = computeGroupCount(alerts);
  lastUpdated.textContent = fmtClock(new Date());
}

/* =========================
   Main refresh
========================= */
let refreshTimer = null;

async function refreshAlerts(isManual=false){
  if(isManual){
    refreshBtn.disabled = true;
    refreshBtn.textContent = "Refreshing…";
  }

  try{
    const alerts = await fetchAlertsPA();

    // Baseline first successful load: show alerts, but do NOT populate recent changes
    const currentIndex = indexAlerts(alerts);
    if(!hasBaselined){
      previousAlertIndex = currentIndex;
      hasBaselined = true;

      renderTable(alerts);
      renderMap(alerts);
      setMeta(alerts);
      renderRecentChanges(); // stays empty
      return;
    }

    // After baseline: diff and log
    const changes = diffAlerts(previousAlertIndex, currentIndex);
    if(changes.length){
      // newest first
      recentChanges.unshift(...changes);
      // cap list
      recentChanges = recentChanges.slice(0, 60);
      renderRecentChanges();
    }

    previousAlertIndex = currentIndex;

    renderTable(alerts);
    renderMap(alerts);
    setMeta(alerts);

  }catch(err){
    console.error(err);
    alertBody.innerHTML = `<tr><td colspan="3" class="smallMuted">Error loading alerts. Try refresh.</td></tr>`;
  }finally{
    if(isManual){
      refreshBtn.disabled = false;
      refreshBtn.textContent = "Refresh";
    }
  }
}

function startAutoRefresh(){
  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(() => refreshAlerts(false), AUTO_REFRESH_MS);
}

/* =========================
   Utilities
========================= */
function fmtTime(iso){
  if(!iso) return "—";
  const d = new Date(iso);
  if(isNaN(d.getTime())) return iso;
  return d.toLocaleString(undefined, {
    month: "2-digit",
    day: "2-digit",
    year: "2-digit",
    hour: "2-digit",
    minute: "2-digit"
  });
}

function fmtClock(d){
  try{
    return d.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  }catch{
    return "—";
  }
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// used in popup styling (keeps it readable in both themes)
function varColorMuted(){
  // not perfect, but good enough for popup; keeps popup readable on both themes
  return document.body.classList.contains("dark") ? "#b7b7b7" : "#555555";
}

/* =========================
   Boot
========================= */
initMap();
refreshAlerts(false);
startAutoRefresh();
</script>
</body>
</html>
