<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PA Watches, Warnings & Advisories â€” Display</title>

<style>
:root{
  color-scheme: light;
  --bg:#ffffff;
  --text:#111111;
  --muted:#555555;
  --border:#333333;
  --borderSoft:#cccccc;
  --tableHeadBg:#f0f0f0;
  --btnBg:#ffffff;
  --btnBgHover:#f3f3f3;

  --watchBg: rgba(255,165,0,0.5);
  --warningBg: rgba(220,38,38,0.5);
  --advBg: rgba(255,235,59,0.55);
}

:root[data-theme="dark"]{
  color-scheme: dark;
  --bg:#0f1216;
  --text:#e9eef5;
  --muted:#a8b2bf;
  --border:#2b3646;
  --borderSoft:#2b3646;
  --tableHeadBg:#1b2330;
  --btnBg:#171c22;
  --btnBgHover:#232b36;

  --watchBg: rgba(255,165,0,0.35);
  --warningBg: rgba(220,38,38,0.35);
  --advBg: rgba(255,235,59,0.25);
}

html,body{
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}

.wrap{
  height:100vh;
  display:grid;
  grid-template-rows:auto auto 1fr;
  gap:10px;
  padding:10px;
  box-sizing:border-box;
}

.title-row{
  display:flex;
  align-items:center;
  gap:12px;
}
.title-row h1{margin:0;font-size:1.35rem;}
.spacer{flex:1}

button{
  padding:6px 12px;
  border-radius:6px;
  border:1px solid var(--border);
  background:var(--btnBg);
  color:var(--text);
  cursor:pointer;
}
button:hover{background:var(--btnBgHover);}

.controls{
  display:flex;
  align-items:center;
  gap:12px;
  font-size:.95em;
  color:var(--muted);
}

.grid{
  display:grid;
  grid-template-rows:auto 1fr;
  gap:10px;
  min-height:0;
}

.panel{
  border:1px solid var(--border);
  border-radius:10px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

.hdr{
  padding:8px 10px;
  background:var(--tableHeadBg);
  border-bottom:1px solid var(--border);
  font-weight:700;
}

.body{
  padding:8px 10px;
  min-height:0;
}

/* MAP + RADAR */
.visuals{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

#wwaMap{
  width:100%;
  height:auto;
  border:1px solid var(--borderSoft);
  visibility:hidden;
}

.radarFrame{
  width:100%;
  border:1px solid var(--borderSoft);
  overflow:hidden;
}
.radarFrame iframe{
  width:100%;
  height:100%;
  border:0;
  pointer-events:none;
}

/* TABLE */
table{
  border-collapse:collapse;
  width:100%;
}
th,td{
  padding:6px;
  border:1px solid var(--border);
  vertical-align:top;
}
th{background:var(--tableHeadBg);text-align:left;}

.type-cell{font-weight:600;}
.type-warning{background:var(--warningBg);}
.type-watch{background:var(--watchBg);}
.type-adv{background:var(--advBg);}

/* AUTO SCROLL */
.auto-scroll{
  overflow:hidden;
  position:relative;
}
.auto-scroll-inner{
  will-change:transform;
}
.auto-scroll:hover .auto-scroll-inner{
  animation-play-state:paused;
}

@keyframes summaryScroll{
  0%{transform:translateY(0);}
  80%{transform:translateY(calc(-1 * var(--scroll-distance)));}
  100%{transform:translateY(0);}
}
</style>
</head>

<body>

<div class="wrap">
  <div class="title-row">
    <h1>PA Watches, Warnings & Advisories</h1>
    <div class="spacer"></div>
    <button id="themeToggle">ðŸŒ™ Dark</button>
  </div>

  <div class="controls">
    <span>Auto-refresh: 5 min</span>
    <button id="refreshBtn">Refresh</button>
    <span id="status">Loadingâ€¦</span>
  </div>

  <div class="grid">
    <!-- MAP + RADAR -->
    <div class="panel">
      <div class="hdr">PA Alert Map & Radar</div>
      <div class="body">
        <div class="visuals">
          <img id="wwaMap"
            src="https://www.weather.gov/images/crh/noc/wwa_pa.png"
            onload="mapLoaded()"
            onerror="mapError()"
            alt="PA Alerts Map"/>

          <div class="radarFrame" id="radarFrame">
            <iframe
              src="https://embed.windy.com/embed2.html?lat=40.9&lon=-77.9&zoom=6&overlay=radar&product=radar&menu=&message=&type=map"
              loading="lazy">
            </iframe>
          </div>
        </div>
      </div>
    </div>

    <!-- ALERT SUMMARY -->
    <div class="panel">
      <div class="hdr">Alert Summary</div>
      <div class="body auto-scroll">
        <div id="tableContainer" class="auto-scroll-inner"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* THEME */
(() => {
  const root=document.documentElement;
  const btn=document.getElementById("themeToggle");
  const saved=localStorage.getItem("pa_alerts_theme")||"system";
  function apply(t){
    if(t==="system"){
      root.dataset.theme=matchMedia("(prefers-color-scheme:dark)").matches?"dark":"light";
    }else root.dataset.theme=t;
    btn.textContent=root.dataset.theme==="dark"?"â˜€ï¸ Light":"ðŸŒ™ Dark";
  }
  apply(saved);
  btn.onclick=()=>{
    const n=root.dataset.theme==="dark"?"light":"dark";
    localStorage.setItem("pa_alerts_theme",n);
    apply(n);
  };
})();

/* MAP/RADAR SYNC */
function mapLoaded(){
  const m=document.getElementById("wwaMap");
  const r=document.getElementById("radarFrame");
  m.style.visibility="visible";
  requestAnimationFrame(()=>r.style.height=m.getBoundingClientRect().height+"px");
}
function mapError(){
  document.getElementById("radarFrame").style.height="520px";
}

/* ALERT FETCH */
const API="https://api.weather.gov/alerts/active?area=PA";
const zoneCache=new Map();

function typePriority(e){
  e=e.toLowerCase();
  if(e.includes("warning")||e.includes("emergency"))return 0;
  if(e.includes("watch"))return 1;
  return 2;
}
function typeClass(e){
  e=e.toLowerCase();
  if(e.includes("warning")||e.includes("emergency"))return "type-warning";
  if(e.includes("watch"))return "type-watch";
  return "type-adv";
}
function fmt(t){
  if(!t)return"N/A";
  const d=new Date(t);
  return d.toLocaleString([],{
    month:"2-digit",day:"2-digit",year:"2-digit",
    hour:"2-digit",minute:"2-digit"
  });
}

async function zoneName(url){
  if(zoneCache.has(url))return zoneCache.get(url);
  const r=await fetch(url,{headers:{Accept:"application/geo+json"}});
  const j=await r.json();
  const n=j.properties?.state==="PA"?j.properties.name:null;
  zoneCache.set(url,n);
  return n;
}

async function fetchAlerts(){
  const status=document.getElementById("status");
  const r=await fetch(API,{headers:{Accept:"application/geo+json"}});
  const d=await r.json();

  const groups=new Map();
  for(const f of d.features||[]){
    const p=f.properties;
    if(!p)continue;
    const e=p.event.toLowerCase();
    if(!(e.includes("warning")||e.includes("watch")||e.includes("advisory")))continue;

    const names=[];
    for(const z of p.affectedZones||[]){
      if(z.includes("/marine/"))continue;
      const n=await zoneName(z);
      if(n)names.push(n);
    }
    if(!names.length)continue;

    const k=p.event+"||"+(p.ends||p.expires||"");
    if(!groups.has(k))
      groups.set(k,{event:p.event,expires:p.ends||p.expires,names:new Set()});
    names.forEach(n=>groups.get(k).names.add(n));
  }

  let arr=[...groups.values()];
  arr.sort((a,b)=>{
    const tp=typePriority(a.event)-typePriority(b.event);
    if(tp!==0)return tp;
    return new Date(a.expires)-new Date(b.expires);
  });

  const html=`
  <table>
    <tr><th>Type</th><th>Locations</th><th>Expires</th></tr>
    ${arr.map(g=>`
      <tr>
        <td class="type-cell ${typeClass(g.event)}">${g.event}</td>
        <td>${[...g.names].sort().join("; ")}</td>
        <td>${fmt(g.expires)}</td>
      </tr>
    `).join("")}
  </table>`;
  document.getElementById("tableContainer").innerHTML=html;

  status.textContent=`Last updated ${new Date().toLocaleTimeString()}`;
  setupAutoScroll();
}

function setupAutoScroll(){
  const outer=document.querySelector(".auto-scroll");
  const inner=document.querySelector(".auto-scroll-inner");
  inner.style.animation="none";

  const overflow=inner.scrollHeight-outer.clientHeight;
  if(overflow<=0)return;

  inner.style.setProperty("--scroll-distance",overflow+"px");
  const duration=Math.max(20,overflow/20);
  inner.style.animation=`summaryScroll ${duration}s linear infinite`;
}

document.getElementById("refreshBtn").onclick=fetchAlerts;
fetchAlerts();
setInterval(fetchAlerts,300000);
</script>
</body>
</html>
