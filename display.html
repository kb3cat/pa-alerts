<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PA Watches, Warnings & Advisories â€” Display</title>

  <style>
    :root{
      color-scheme: light;

      --bg: #ffffff;
      --text: #111111;
      --muted: #555555;

      --border: #333333;
      --borderSoft: #cccccc;

      --tableHeadBg: #f0f0f0;

      --btnBg: #ffffff;
      --btnBgHover: #f3f3f3;
      --btnBorder: #333333;
      --btnBorderSoft: #555555;

      --preBg: #f6f6f6;
      --preBorder: #dddddd;

      --watchBg: rgba(255, 165, 0, 0.5);
      --warningBg: rgba(220, 38, 38, 0.5);
      --advBg: rgba(255, 235, 59, 0.55);

      /* Map fallback palette */
      --mapFallbackBg: #f6f6f6;
      --mapFallbackBorder: #999999;
    }

    :root[data-theme="dark"]{
      color-scheme: dark;

      --bg: #0f1216;
      --text: #e9eef5;
      --muted: #a8b2bf;

      --border: #2b3646;
      --borderSoft: #2b3646;

      --tableHeadBg: #1b2330;

      --btnBg: #171c22;
      --btnBgHover: #232b36;
      --btnBorder: #2b3646;
      --btnBorderSoft: #2b3646;

      --preBg: #0f141b;
      --preBorder: #2b3646;

      --watchBg: rgba(255, 165, 0, 0.35);
      --warningBg: rgba(220, 38, 38, 0.35);
      --advBg: rgba(255, 235, 59, 0.25);

      /* Map fallback palette */
      --mapFallbackBg: #0f141b;
      --mapFallbackBorder: #2b3646;
    }

    html, body { background: var(--bg); color: var(--text); margin:0; }

    /* -------- Option A Layout -------- */
    .wrap{
      height:100vh;
      display:grid;
      grid-template-rows:auto auto 1fr;
      gap:10px;
      padding:10px;
      box-sizing:border-box;
    }

    .title-row{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .title-row h1{ margin:0; font-size:1.35rem; }
    .title-row .spacer{ flex: 1 1 auto; }

    #themeToggle, #refreshBtn{
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--btnBorder);
      background: var(--btnBg);
      cursor: pointer;
      font: inherit;
      color: var(--text);
    }
    #themeToggle:hover, #refreshBtn:hover{ background: var(--btnBgHover); }
    #refreshBtn:disabled{ opacity:0.6; cursor:not-allowed; }

    .controls{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size:0.95em;
    }

    .grid{
      height:100%;
      display:grid;
      grid-template-rows: 56% 44%; /* top visuals, bottom summary */
      gap:10px;
      min-height:0;
    }

    .panel{
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
      background: transparent;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .panel .hdr{
      padding:8px 10px;
      background: var(--tableHeadBg);
      border-bottom:1px solid var(--border);
      font-weight:700;
    }
    .panel .body{
      padding:8px 10px;
      min-height:0;
      overflow:auto;
    }

    /* Top visuals split */
    .visuals{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      min-height:0;
      align-items:start;
    }

    /* Map */
    #wwaMap{
      width:100%;
      height:auto;
      border:1px solid var(--borderSoft);
      visibility:hidden; /* prevent broken-image flash */
      display:block;
      max-height:100%;
      object-fit:contain;
    }

    .map-fallback{
      display: none;
      width: 100%;
      min-height: 240px;
      border: 2px dashed var(--mapFallbackBorder);
      background: var(--mapFallbackBg);
      border-radius: 10px;
      padding: 18px;
      box-sizing: border-box;
      align-items: flex-start;
      justify-content: center;
      text-align: center;
    }
    .map-fallback .title{
      font-weight: 700;
      font-size: 1.05rem;
      margin-bottom: 6px;
    }
    .map-fallback .text{
      color: var(--muted);
      line-height: 1.35;
      max-width: 70ch;
      margin:0 auto;
    }

    /* Radar: non-movable */
    .radarFrame{
      width:100%;
      height:100%;
      border:1px solid var(--borderSoft);
      overflow:hidden;
      background: transparent;
      min-height:0;
    }
    .radarFrame iframe{
      width:100%;
      height:100%;
      border:0;
      display:block;
      pointer-events:none; /* lock it */
    }

    /* Summary table */
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 6px; border: 1px solid var(--border); vertical-align: top; }
    th { background: var(--tableHeadBg); text-align:left; }

    .type-cell { font-weight: 600; color: var(--text); }
    .type-watch   { background-color: var(--watchBg); }
    .type-warning { background-color: var(--warningBg); }
    .type-adv     { background-color: var(--advBg); }

    .muted { color: var(--muted); font-size: 0.95em; }

    /* Make summary rows readable when locations are long */
    td{ word-break: break-word; }
  </style>
</head>

<body>
  <!-- Force refresh on open (same trick you liked) -->
  <script>
  (() => {
    const KEY = "paalerts_refreshed_once";
    const pageKey = `${KEY}:${location.pathname}`;
    const nav = performance.getEntriesByType?.("navigation")?.[0];
    const wasBFCache = nav?.type === "back_forward";

    if (!sessionStorage.getItem(pageKey) || wasBFCache) {
      sessionStorage.setItem(pageKey, "1");
      const url = new URL(location.href);
      url.searchParams.set("_ts", Date.now().toString());
      location.replace(url.toString());
    }
  })();
  </script>

  <div class="wrap">
    <div class="title-row">
      <h1>PA Watches, Warnings & Advisories</h1>
      <div class="spacer"></div>
      <button id="themeToggle" type="button">ðŸŒ™ Dark</button>
    </div>

    <div class="controls">
      <span class="muted">Auto-refresh: every 5 minutes</span>
      <button id="refreshBtn" type="button">Refresh Now</button>
      <span id="status" class="muted">Loading alertsâ€¦</span>
    </div>

    <div class="grid">

      <!-- TOP: MAP + RADAR -->
      <div class="panel">
        <div class="hdr">PA Alert Map & Radar</div>
        <div class="body" style="padding:6px;">
          <div class="visuals">

            <!-- Map -->
            <div>
              <img
                id="wwaMap"
                src="https://www.weather.gov/images/crh/noc/wwa_pa.png"
                alt="NWS Current Watches, Warnings, and Advisories (PA)"
                onload="handleWwaMapLoad()"
                onerror="showWwaMapFallback()"
              />

              <div id="wwaMapFallback" class="map-fallback" role="status" aria-live="polite">
                <div>
                  <div class="title">NWS Alert Map Unavailable</div>
                  <div class="text">
                    The NWS Watches, Warnings, and Advisories map is currently unavailable.<br />
                    Alert data remains valid and is displayed below.
                  </div>
                </div>
              </div>
            </div>

            <!-- Radar (PA centered) -->
            <div class="radarFrame" aria-label="Locked radar">
              <iframe
                title="Windy Radar (locked)"
                src="https://embed.windy.com/embed2.html?lat=40.9&lon=-77.9&detailLat=40.9&detailLon=-77.9&width=600&height=520&zoom=6&level=surface&overlay=radar&product=radar&menu=&message=&marker=&calendar=&pressure=&type=map&location=coordinates&detail=&metricWind=mph&metricTemp=%C2%B0F&radarRange=-1"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                allowfullscreen>
              </iframe>
            </div>

          </div>
        </div>
      </div>

      <!-- BOTTOM: SUMMARY (full width) -->
      <div class="panel">
        <div class="hdr">Summary</div>
        <div class="body" id="tableContainer"></div>
      </div>

    </div>
  </div>

  <script>
    /* ==============================
       THEME TOGGLE (same as your pages)
       ============================== */
    (function () {
      const STORAGE_KEY_THEME = "pa_alerts_theme";
      const root = document.documentElement;
      const btn = document.getElementById("themeToggle");

      function systemPrefersDark() {
        return window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
      }

      function setTheme(theme) {
        if (theme === "system") {
          root.setAttribute("data-theme", systemPrefersDark() ? "dark" : "light");
        } else {
          root.setAttribute("data-theme", theme);
        }
        if (btn) {
          const isDark = root.getAttribute("data-theme") === "dark";
          btn.textContent = isDark ? "â˜€ï¸ Light" : "ðŸŒ™ Dark";
        }
      }

      const saved = localStorage.getItem(STORAGE_KEY_THEME) || "system";

      if (saved === "system" && window.matchMedia) {
        const mq = window.matchMedia("(prefers-color-scheme: dark)");
        if (mq.addEventListener) mq.addEventListener("change", () => setTheme("system"));
        else if (mq.addListener) mq.addListener(() => setTheme("system"));
      }

      setTheme(saved);

      if (btn) {
        btn.addEventListener("click", () => {
          const current = root.getAttribute("data-theme") === "dark" ? "dark" : "light";
          const next = current === "dark" ? "light" : "dark";
          localStorage.setItem(STORAGE_KEY_THEME, next);
          setTheme(next);
        });
      }
    })();

    // If something blows up, don't leave "Loading..." forever
    window.addEventListener("error", (e) => {
      const s = document.getElementById("status");
      if (s) s.textContent = "Script error: " + (e?.message || "Unknown error");
    });

    const API_URL = "https://api.weather.gov/alerts/active?area=PA";
    const MAP_URL = "https://www.weather.gov/images/crh/noc/wwa_pa.png";

    /* ==============================
       MAP FALLBACK (no-blip)
       ============================== */
    function showWwaMapFallback() {
      const img = document.getElementById("wwaMap");
      const fallback = document.getElementById("wwaMapFallback");
      if (img) {
        img.style.display = "none";
        img.style.visibility = "hidden";
      }
      if (fallback) fallback.style.display = "flex";
    }

    function handleWwaMapLoad() {
      const img = document.getElementById("wwaMap");
      const fallback = document.getElementById("wwaMapFallback");
      if (fallback) fallback.style.display = "none";
      if (img) {
        img.style.display = "block";
        img.style.visibility = "visible";
      }
    }

    function refreshMap() {
      const img = document.getElementById("wwaMap");
      const fallback = document.getElementById("wwaMapFallback");
      if (fallback) fallback.style.display = "none";
      if (img) {
        img.style.display = "block";
        img.style.visibility = "hidden";
        img.src = MAP_URL + "?t=" + Date.now();
      }
    }

    window.addEventListener("load", () => {
      const img = document.getElementById("wwaMap");
      if (!img) return;
      if (img.complete) {
        if (img.naturalWidth > 0) handleWwaMapLoad();
        else showWwaMapFallback();
      }
    });

    /* ==============================
       Advisory-page matching logic
       - affectedZones -> fetch zone names
       - PA only
       - FINAL end time: ends || expires
       - Group by event + expires; combine locations
       ============================== */
    const zoneCache = new Map();

    function formatTime(v) {
      if (!v) return "N/A";
      const d = new Date(v);
      // mm/dd/yy + time
      return isNaN(d) ? String(v) : d.toLocaleString([], {
        month:"2-digit", day:"2-digit", year:"2-digit",
        hour:"2-digit", minute:"2-digit"
      });
    }

    function toTimeMs(v) {
      const t = new Date(v || 0).getTime();
      return isNaN(t) ? Number.MAX_SAFE_INTEGER : t;
    }

    function isWantedAlert(p) {
      const e = (p.event || "").toLowerCase();
      return (
        (e.includes("watch") || e.includes("warning") || e.includes("advisory") || e.includes("emergency")) &&
        !e.includes("statement") &&
        !e.includes("outlook") &&
        !e.includes("test")
      );
    }

    function isMarineZone(url) {
      return typeof url === "string" && url.includes("/zones/marine/");
    }

    function fetchWithTimeout(url, options = {}, timeoutMs = 10000) {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), timeoutMs);
      return fetch(url, { ...options, signal: controller.signal })
        .finally(() => clearTimeout(t));
    }

    async function fetchZone(url) {
      if (zoneCache.has(url)) return zoneCache.get(url);
      try {
        const r = await fetchWithTimeout(url, { headers: { "Accept": "application/geo+json" } }, 10000);
        if (!r.ok) throw new Error("HTTP " + r.status);
        const d = await r.json();
        const info = { name: d.properties?.name, state: d.properties?.state };
        zoneCache.set(url, info);
        return info;
      } catch {
        return null;
      }
    }

    function locationSortKey(name) {
      return String(name || "")
        .trim()
        .replace(/^(n|s|e|w|ne|nw|se|sw|north|south|east|west|upper|lower|higher elevations?|northern|southern|eastern|western|northeastern|northwestern|southeastern|southwestern)\b\.?\s+/i, "")
        .trim()
        .toLowerCase();
    }

    function sortLocations(arr) {
      return [...arr].sort((a, b) => {
        const ka = locationSortKey(a);
        const kb = locationSortKey(b);
        return ka === kb ? String(a).localeCompare(String(b)) : ka.localeCompare(kb);
      });
    }

    function normalizeSummaryCounty(name) {
      let s = String(name || "").trim();
      s = s.replace(/^(Higher\s+Elevations\s+of|Elevations\s+of)\s+/i, "");
      s = s.replace(/^(Upper|Lower|North|South|East|West|NE|NW|SE|SW|Northeast|Northwest|Southeast|Southwest|Northern|Southern|Eastern|Western)\b\.?\s+/i, "");
      s = s.replace(/\s+(Ridges?|Ridge|Higher\s+Elevations?)$/i, "");
      return s.trim();
    }

    function typeClass(e) {
      e = (e || "").toLowerCase();
      if (e.includes("watch")) return "type-watch";
      if (e.includes("warning") || e.includes("emergency")) return "type-warning";
      return "type-adv";
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function fetchAlerts() {
      const status = document.getElementById("status");
      const refreshBtn = document.getElementById("refreshBtn");
      const container = document.getElementById("tableContainer");

      refreshBtn.disabled = true;
      status.textContent = "Loading alertsâ€¦";

      try {
        const r = await fetchWithTimeout(
          API_URL,
          { headers: { "Accept": "application/geo+json" }, cache: "no-store" },
          12000
        );
        if (!r.ok) throw new Error("HTTP " + r.status);

        const d = await r.json();
        const features = Array.isArray(d.features) ? d.features : [];

        const rows = [];
        for (const f of features) {
          const p = f?.properties;
          if (!p || !isWantedAlert(p)) continue;

          const zones = (p.affectedZones || []).filter(z => !isMarineZone(z));
          if (!zones.length) continue;

          const zoneInfos = await Promise.all(zones.map(z => fetchZone(z)));

          const names = [];
          for (const info of zoneInfos) {
            if (info && info.state === "PA" && info.name) names.push(info.name);
          }
          if (!names.length) continue;

          // âœ… final end time (matches advisories page)
          const expires = p.ends || p.expires;

          rows.push({
            event: p.event,
            expires,
            names: [...new Set(names)].map(normalizeSummaryCounty)
          });
        }

        const nowStr = new Date().toLocaleString([], { month:"numeric", day:"numeric", year:"numeric", hour:"numeric", minute:"2-digit", second:"2-digit" });
        if (!rows.length) {
          container.innerHTML = `<div class="muted">No active watches, warnings, or advisories.</div>`;
          status.textContent = `Last updated: ${nowStr} | Groups: 0`;
          return;
        }

        // Group by event + expires; combine names
        const grouped = new Map();
        for (const row of rows) {
          const k = `${row.event}||${row.expires || ""}`;
          if (!grouped.has(k)) grouped.set(k, { event: row.event, expires: row.expires, names: new Set() });
          row.names.forEach(n => grouped.get(k).names.add(n));
        }

        // Sort: earliest expiry first, then event
        const groupedArr = [...grouped.values()].sort((a, b) => {
          const ae = toTimeMs(a.expires);
          const be = toTimeMs(b.expires);
          return ae - be || String(a.event).localeCompare(String(b.event));
        });

        status.textContent = `Last updated: ${nowStr} | Groups: ${groupedArr.length}`;

        container.innerHTML = `
          <table>
            <colgroup>
              <col style="width: 22%;">
              <col style="width: 63%;">
              <col style="width: 15%;">
            </colgroup>
            <tr><th>Type</th><th>Locations</th><th>Expires</th></tr>
            ${groupedArr.map(g => {
              const namesSorted = sortLocations([...g.names]);
              return `
                <tr>
                  <td class="type-cell ${typeClass(g.event)}">${escapeHtml(g.event)}</td>
                  <td>${namesSorted.map(escapeHtml).join("; ")}</td>
                  <td>${escapeHtml(formatTime(g.expires))}</td>
                </tr>
              `;
            }).join("")}
          </table>
        `;

      } catch (err) {
        console.error(err);
        status.textContent = "Error loading alerts: " + (err?.message || String(err));
        container.innerHTML = `<div class="muted">Unable to load alerts.</div>`;
      } finally {
        refreshBtn.disabled = false;
      }
    }

    function refreshAll(){
      refreshMap();
      fetchAlerts();
    }

    document.getElementById("refreshBtn").onclick = refreshAll;

    // initial + periodic
    fetchAlerts();
    refreshMap();
    setInterval(refreshAll, 5 * 60 * 1000);

    // Clean address bar after cache-bust
    if (location.search.includes("_ts=")) {
      history.replaceState(null, "", location.pathname);
    }
  </script>
</body>
</html>
