<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Regional Weather Summary (RWSCTP)</title>

  <style>
    /* ==============================
       THEME (LIGHT DEFAULT)
       ============================== */
    :root{
      color-scheme: light;

      --bg: #ffffff;
      --text: #111111;
      --muted: #555555;

      --border: #333333;
      --borderSoft: #cccccc;

      --btnBg: #ffffff;
      --btnBgHover: #f3f3f3;
      --btnBorder: #333333;

      --panelBg: #fafafa;
      --panelBorder: #cccccc;

      --meta: #333333;

      --preBg: #ffffff;
      --preBorder: #dddddd;

      --link: #1d4ed8;
    }

    /* ==============================
       THEME (DARK)
       ============================== */
    :root[data-theme="dark"]{
      color-scheme: dark;

      --bg: #0f1216;
      --text: #e9eef5;
      --muted: #a8b2bf;

      --border: #2b3646;
      --borderSoft: #2b3646;

      --btnBg: #171c22;
      --btnBgHover: #232b36;
      --btnBorder: #2b3646;

      --panelBg: #121820;
      --panelBorder: #2b3646;

      --meta: #a8b2bf;

      --preBg: #0f141b;
      --preBorder: #2b3646;

      --link: #7aa2ff;
    }

    html, body { background: var(--bg); color: var(--text); }
    body { margin: 16px; }

    /* ==============================
       TITLE ROW (MATCHES OTHER PAGES)
       ============================== */
    .title-row{
      max-width: 1200px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px; /* space under header */
    }
    .title-row h1{
      margin: 0; /* prevents phantom top margin */
    }
    .title-row .spacer{ flex: 1 1 auto; }

    /* ==============================
       CONTROLS
       ============================== */
    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      max-width: 1200px;
    }

    .nav-toggle { font-size: 0.95em; }

    .nav-toggle button,
    #refreshBtn,
    #themeToggle {
      margin-left: 8px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--btnBorder);
      background: var(--btnBg);
      cursor: pointer;
      font: inherit;
      color: var(--text);
    }
    .nav-toggle button:hover,
    #refreshBtn:hover,
    #themeToggle:hover { background: var(--btnBgHover); }

    #refreshBtn:disabled { opacity: 0.6; cursor: not-allowed; }

    .refresh-label { font-size: 0.95em; color: var(--meta); }

    .muted { color: var(--muted); font-size: 0.95em; max-width: 1200px; }
    .section-title { margin-top: 14px; margin-bottom: 6px; max-width: 1200px; }

    /* ==============================
       PANEL
       ============================== */
    .panel {
      max-width: 1200px;
      border: 1px solid var(--panelBorder);
      border-radius: 10px;
      padding: 12px 14px;
      background: var(--panelBg);
    }
    .panel h2 {
      margin: 0 0 6px;
      font-size: 1.05em;
    }
    .meta {
      margin: 0 0 10px;
      color: var(--meta);
      font-size: 0.95em;
    }
    pre {
      margin: 0;
      padding: 10px;
      border: 1px solid var(--preBorder);
      border-radius: 8px;
      background: var(--preBg);
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      line-height: 1.35;
      font-size: 0.98em;
    }
    a { color: var(--link); }
  </style>
</head>

<body>
  <div class="title-row">
    <h1>Regional Weather Summary (RWSCTP)</h1>
    <div class="spacer"></div>
    <button id="themeToggle" type="button">ðŸŒ™ Dark</button>
  </div>

  <div class="controls">
    <div class="nav-toggle">
      Back to alerts?
      <button type="button" onclick="window.location.href='index.html'">Watches/Warnings</button>
      <button type="button" onclick="window.location.href='advisories.html'">Advisories</button>
    </div>
  </div>

  <div class="controls">
    <span class="refresh-label">Auto-refresh: every 5 minutes</span>
    <button id="refreshBtn" type="button">Refresh Now</button>
  </div>

  <p id="status" class="muted">Loading RWSâ€¦</p>

  <h2 class="section-title">Latest Text</h2>

  <div class="panel">
    <h2 id="prodTitle">RWS (CTP)</h2>
    <p id="prodMeta" class="meta">â€”</p>
    <pre id="prodText">Loadingâ€¦</pre>
  </div>

  <p class="muted" style="margin-top:10px;">
    Source:
    <a id="listLink" href="#" target="_blank" rel="noopener noreferrer">
      NWS API (Products: RWS / CTP)
    </a>
    &nbsp;|&nbsp;
    <a id="prodLink" href="#" target="_blank" rel="noopener noreferrer">
      Latest product
    </a>
  </p>

  <script>
    /* ==============================
       THEME TOGGLE (shared across pages)
       ============================== */
    (function () {
      const STORAGE_KEY_THEME = "pa_alerts_theme";
      const root = document.documentElement;
      const btn = document.getElementById("themeToggle");

      function systemPrefersDark() {
        return window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
      }

      function setTheme(theme) {
        if (theme === "system") {
          root.setAttribute("data-theme", systemPrefersDark() ? "dark" : "light");
        } else {
          root.setAttribute("data-theme", theme);
        }
        if (btn) {
          const isDark = root.getAttribute("data-theme") === "dark";
          btn.textContent = isDark ? "â˜€ï¸ Light" : "ðŸŒ™ Dark";
        }
      }

      const saved = localStorage.getItem(STORAGE_KEY_THEME) || "system";

      if (saved === "system" && window.matchMedia) {
        const mq = window.matchMedia("(prefers-color-scheme: dark)");
        if (mq.addEventListener) mq.addEventListener("change", () => setTheme("system"));
        else if (mq.addListener) mq.addListener(() => setTheme("system"));
      }

      setTheme(saved);

      if (btn) {
        btn.addEventListener("click", () => {
          const current = root.getAttribute("data-theme") === "dark" ? "dark" : "light";
          const next = current === "dark" ? "light" : "dark";
          localStorage.setItem(STORAGE_KEY_THEME, next);
          setTheme(next);
        });
      }
    })();

    const LIST_URL = "https://api.weather.gov/products/types/RWS/locations/CTP";

    function fmtTime(v) {
      if (!v) return "N/A";
      const d = new Date(v);
      return isNaN(d) ? String(v) : d.toLocaleString();
    }

    function cleanText(t) {
      return t ? String(t).replace(/\n{3,}/g, "\n\n").trim() : "No text returned.";
    }

    async function fetchJson(url) {
      const r = await fetch(url, { headers: { "Accept": "application/geo+json" } });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    function pickLatestProduct(items) {
      if (!Array.isArray(items) || items.length === 0) return null;

      return items
        .map(p => ({
          p,
          t: Date.parse(p.issuanceTime || p.issueTime || p.created || "")
        }))
        .sort((a, b) => b.t - a.t)[0]?.p || null;
    }

    function getLatestUrl(latest) {
      return (
        latest?.["@id"] ||
        latest?.id ||
        latest?.url ||
        (latest?.productId
          ? `https://api.weather.gov/products/${latest.productId}`
          : null)
      );
    }

    async function refreshRWS() {
      const status = document.getElementById("status");
      const btn = document.getElementById("refreshBtn");

      btn.disabled = true;
      status.textContent = "Loading RWSâ€¦";

      try {
        document.getElementById("listLink").href = LIST_URL;

        const listing = await fetchJson(LIST_URL);
        const products = listing.products || listing["@graph"] || listing.items || [];
        const latest = pickLatestProduct(products);

        if (!latest) {
          status.textContent = "No RWS products found.";
          document.getElementById("prodText").textContent =
            "No Regional Weather Summary is currently available.";
          return;
        }

        const latestUrl = getLatestUrl(latest);
        document.getElementById("prodLink").href = latestUrl;

        const prod = await fetchJson(latestUrl);

        const issued = prod.issuanceTime || prod.issueTime || "";
        const wmo = prod.wmoCollectiveId || "";
        const awips = prod.awipsId || "";

        document.getElementById("prodTitle").textContent =
          `${prod.productName || "Regional Weather Summary"} â€” CTP`;

        document.getElementById("prodMeta").textContent =
          `Issued: ${fmtTime(issued)}`
          + (wmo ? ` | WMO: ${wmo}` : "")
          + (awips ? ` | AWIPS: ${awips}` : "");

        document.getElementById("prodText").textContent =
          cleanText(prod.productText || prod.text || "");

        status.textContent = `Last updated: ${new Date().toLocaleString()}`;

      } catch (err) {
        console.error(err);
        status.textContent = `Error loading RWS: ${err.message}`;
        document.getElementById("prodText").textContent =
          "Error loading Regional Weather Summary.";
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById("refreshBtn").onclick = refreshRWS;

    refreshRWS();
    setInterval(refreshRWS, 5 * 60 * 1000);
  </script>
</body>
</html>
