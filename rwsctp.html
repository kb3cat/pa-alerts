<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Regional Weather Summary (RWSCTP)</title>

  <style>
    table { border-collapse: collapse; width: 100%; max-width: 1200px; }
    th, td { padding: 6px; border: 1px solid #333; vertical-align: top; }
    th { background: #f0f0f0; }

    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .refresh-label { font-size: 0.95em; color: #333; }

    /* Match your existing site button style */
    #refreshBtn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #fff;
      cursor: pointer;
      font: inherit;
    }
    #refreshBtn:hover { background: #f3f3f3; }
    #refreshBtn:disabled { opacity: 0.6; cursor: not-allowed; }

    .section-title { margin-top: 16px; margin-bottom: 6px; }
    .muted { color: #555; font-size: 0.95em; max-width: 1200px; }

    .box {
      max-width: 1200px;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 12px;
      background: #fafafa;
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      margin: 0;
      padding: 10px;
      background: #f6f6f6;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 0.95em;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <h1>Regional Weather Summary (RWSCTP)</h1>

  <div class="controls">
    <span class="refresh-label">Auto-refresh: every 5 minutes</span>
    <button id="refreshBtn" type="button">Refresh Now</button>
  </div>

  <p id="status">Loading RWS…</p>

  <h2 class="section-title">Latest Text</h2>
  <div class="box">
    <pre id="rwsText">Loading…</pre>
  </div>

  <p class="muted" style="margin-top:10px;">
    Source:
    <a id="sourceLink" href="https://api.weather.gov/products/types/RWS" target="_blank" rel="noopener noreferrer">
      NWS API (Products: RWS)
    </a>
  </p>

  <script>
    // Pull the newest RWS product, then filter to WFO "CTP" (State College)
    // This avoids unreliable /locations/CTP list endpoints that can 404.
    const PRODUCTS_LIST_URL = "https://api.weather.gov/products/types/RWS";
    const TARGET_WFO = "CTP"; // RWSCTP
    const REFRESH_MS = 5 * 60 * 1000;

    function formatTime(v) {
      if (!v) return "N/A";
      const d = new Date(v);
      return isNaN(d) ? String(v) : d.toLocaleString();
    }

    function safeText(v) {
      return (v == null) ? "" : String(v);
    }

    async function fetchJson(url) {
      const r = await fetch(url, { headers: { "Accept": "application/ld+json" } });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    async function fetchText(url) {
      const r = await fetch(url, { headers: { "Accept": "application/ld+json" } });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    async function loadRWS() {
      const status = document.getElementById("status");
      const btn = document.getElementById("refreshBtn");
      const out = document.getElementById("rwsText");
      const sourceLink = document.getElementById("sourceLink");

      btn.disabled = true;
      status.textContent = "Loading RWS…";
      out.textContent = "Loading…";

      try {
        const list = await fetchJson(PRODUCTS_LIST_URL);

        const items = Array.isArray(list["@graph"])
          ? list["@graph"]
          : (Array.isArray(list.products) ? list.products : []);

        if (!items.length) throw new Error("No RWS products returned.");

        // Normalize + filter to WFO CTP
        const ctp = items
          .map(p => ({
            id: p.id || p["@id"] || p.productId,
            wfo: (p.wfo || p.issuingOffice || "").toString(),
            issued: p.issuanceTime || p.issueTime || p.issued || p.validTime || null
          }))
          .filter(p => p.id && p.wfo.toUpperCase() === TARGET_WFO);

        if (!ctp.length) {
          throw new Error(`No RWS products found for WFO ${TARGET_WFO}.`);
        }

        // Newest first
        ctp.sort((a, b) => {
          const at = new Date(a.issued || 0).getTime();
          const bt = new Date(b.issued || 0).getTime();
          const aNum = isNaN(at) ? 0 : at;
          const bNum = isNaN(bt) ? 0 : bt;
          return bNum - aNum;
        });

        const latest = ctp[0];

        // Fetch the actual product text
        const product = await fetchText(latest.id);

        const productText = safeText(product.productText || product.text || product.body || "").trim();
        const issuanceTime = product.issuanceTime || latest.issued;

        status.textContent =
          `Last updated: ${new Date().toLocaleString()} | Issued: ${formatTime(issuanceTime)} | WFO: ${TARGET_WFO}`;

        out.textContent = productText || "No text found in latest product.";

        // Update "Source" link to the exact product for quick checking
        sourceLink.href = latest.id;
        sourceLink.textContent = "NWS API (RWSCTP Product)";

      } catch (err) {
        console.error(err);
        status.textContent = `Error loading RWS: ${err.message}`;
        out.textContent = "Error loading RWS text.";
        // keep source link pointed to the list endpoint when failing
        const sourceLink = document.getElementById("sourceLink");
        sourceLink.href = PRODUCTS_LIST_URL;
        sourceLink.textContent = "NWS API (Products: RWS)";
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById("refreshBtn").onclick = loadRWS;

    loadRWS();
    setInterval(loadRWS, REFRESH_MS);
  </script>
</body>
</html>